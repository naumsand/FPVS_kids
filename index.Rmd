---
title: "Data preparation"
output: 
  rmdformats::material:
    highlight: kate
    css: web_style.css
    thumbnails: false
    lightbox: true
    gallery: true
    cards: true
    self_contained: no
    number_sections: no
    code_folding: hide
    fig_caption: yes
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}

# Set general settings for Markdown file 
  options(max.print="75")

  knitr::opts_chunk$set(echo=TRUE,
  	             #cache=TRUE,
                 prompt=FALSE,
                 tidy=TRUE,
                 comment=NA,
                 message=FALSE,
                 warning=FALSE,
                 results = FALSE,
  	             fig.align="center")
  knitr::opts_knit$set(width=75)
  
# Load packages
  library(dplyr)
  library(eeptools)
  library(expss)
  library(kableExtra)
  library(miceadds)
  library(rstatix)
  library(tidyr)
  library(XLConnect)
  
# Swipe environment
 rm(list=ls())  
 
 options(scipen=999, digits=2)
  
```

# Parent ratings / child assessments

```{r qn_data}

# Load questionnaire data
  qn_data = readWorksheetFromFile("./data/qn_data_fpvs.xlsx",
                             sheet = 1,
                             startCol = 1,
                             endCol = 0)
  
# Re-code gender
  qn_data$sex[qn_data$sex == 1] = "Male"
  qn_data$sex[qn_data$sex == 2] = "Female"
  
# Re-code training group
  qn_data$group[qn_data$group == "ZE"] = "ZE"
  qn_data$group[qn_data$group == "SB"] = "CT"

# Define N/A data
  qn_data[qn_data==-99] = NA
  
# Calculate age (Extract age from birth/test date)
  qn_data$age = as.numeric(cbind(age_calc(as.Date(qn_data$birth_date),
                                     as.Date(qn_data$test_date), units = "years"))) 
  
# Remove birth date and test date column
  qn_data = subset(qn_data, select=-c(birth_date,test_date))
  
# Calculate Winkler-Index 

  # Create Winkler Index 
  
    # For the Winkler Index, one awards points for income, occupation and education level of each
    # parent. Points range from 1-5. These points are added up. The maximum value would be 15 points.
    # For education and occupation, the parent with the larger score was chosen per family. 
  
  # Income
    # 1 = 0-1250 Euro
    # 2 = 1250-2000 Euro
    # 3 = 2000-3000 Euro,
    # 4 = 3000-5000 Euro
    # 5 = more than 5000 Euro
  
    qn_data$income_rec[qn_data$income==1 | qn_data$income==2 | qn_data$income==3 | qn_data$income==4] = 1
    qn_data$income_rec[qn_data$income==5 | qn_data$income==6 | qn_data$income==7] = 2
    qn_data$income_rec[qn_data$income==8 | qn_data$income==9 | qn_data$income==10] = 3
    qn_data$income_rec[qn_data$income==11 | qn_data$income==12] = 4
    qn_data$income_rec[qn_data$income==13] = 5
    
  # Education
    # 1 = no degree
    # 2 = secondary modern school [German: "Hauptschule"]
    # 3 = middle school [German: "Realschule"]
    # 4 = advanced technical college entrance qualification [German: "Fachhochschulreife"]
    # 5 = higher education entrance qualification (A-levels) [German: "Abitur"]
  
  # for mum
    qn_data$mum_ed_rec[qn_data$mum_ed==7 | qn_data$mum_ed==8] = 1
    qn_data$mum_ed_rec[qn_data$mum_ed==1 | qn_data$mum_ed==6] = 2
    qn_data$mum_ed_rec[qn_data$mum_ed==2 | qn_data$mum_ed==3] = 3
    qn_data$mum_ed_rec[qn_data$mum_ed==4] = 4
    qn_data$mum_ed_rec[qn_data$mum_ed==5] = 5

  
  # for dad
    qn_data$dad_ed_rec[qn_data$dad_ed==7 | qn_data$dad_ed==8] = 1
    qn_data$dad_ed_rec[qn_data$dad_ed==1 | qn_data$dad_ed==6] = 2
    qn_data$dad_ed_rec[qn_data$dad_ed==2 | qn_data$dad_ed==3] = 3
    qn_data$dad_ed_rec[qn_data$dad_ed==4] = 4
    qn_data$dad_ed_rec[qn_data$dad_ed==5] = 5
  
  # Occupation 
    # 1 = student
    # 2 = skilled worker [German:Gelernter "Facharbeiter"]
    # 3 = foremen/forwomen [German: "Vorarbeiter"]
    # 4 = clerk in the middle grade of the civil service [German: "Beamter mittlerer Dienst"]
    # 5 = senior officials [German: "Beamte h√∂herer Dienst"]
  
  # for mum
    qn_data$occ_mum[qn_data$mum_occup_ISCO==5 | qn_data$mum_occup_ISCO==11 |
                      qn_data$mum_occup_ISCO==12 | qn_data$mum_occup_ISCO==51 | 
                      qn_data$mum_occup_ISCO==52] = 1
    
    qn_data$occ_mum[qn_data$mum_occup_ISCO==13 | qn_data$mum_occup_ISCO==21 |
                      qn_data$mum_occup_ISCO==26 | qn_data$mum_occup_ISCO==31 |
                      qn_data$mum_occup_ISCO==32] = 2
    
    qn_data$occ_mum[qn_data$mum_occup_ISCO==14 | qn_data$mum_occup_ISCO==33 | 
                      qn_data$mum_occup_ISCO==41] = 3
    
    qn_data$occ_mum[qn_data$mum_occup_ISCO==2 | qn_data$mum_occup_ISCO==22 | 
                      qn_data$mum_occup_ISCO==23 | qn_data$mum_occup_ISCO==24 |
                      qn_data$mum_occup_ISCO==34 | qn_data$mum_occup_ISCO==42] = 4
    
    qn_data$occ_mum[qn_data$mum_occup_ISCO==25 | 
                      qn_data$mum_occup_ISCO==35 | qn_data$mum_occup_ISCO==43 |
                      qn_data$mum_occup_ISCO==44] = 5
  
  # for dad
    qn_data$occ_dad[qn_data$dad_occup_ISCO==5 | qn_data$dad_occup_ISCO==11 |
                      qn_data$dad_occup_ISCO==12 | qn_data$dad_occup_ISCO==51 |
                      qn_data$dad_occup_ISCO==52] = 1
    
    qn_data$occ_dad[qn_data$dad_occup_ISCO==13 | qn_data$dad_occup_ISCO==21 | 
                      qn_data$dad_occup_ISCO==26 | qn_data$dad_occup_ISCO==31 | 
                      qn_data$dad_occup_ISCO==32] = 2
    
    qn_data$occ_dad[qn_data$dad_occup_ISCO==14 | qn_data$dad_occup_ISCO==33 | 
                      qn_data$dad_occup_ISCO==41] = 3
    
    qn_data$occ_dad[qn_data$dad_occup_ISCO==2 | qn_data$dad_occup_ISCO==22 | 
                      qn_data$dad_occup_ISCO==23 | qn_data$dad_occup_ISCO==24 |
                      qn_data$dad_occup_ISCO==34 | qn_data$dad_occup_ISCO==42] = 4
    
    qn_data$occ_dad[qn_data$dad_occup_ISCO==25 | qn_data$dad_occup_ISCO==35 |
                      qn_data$dad_occup_ISCO==43 | qn_data$dad_occup_ISCO==44] = 5
  
  # Calculate Winkler index
    # Sum up all points (choose the parent with the larger score). 
  
    for (h in 1:length(qn_data$ID)){
      qn_data$wink_ind[h] = sum(qn_data$income_rec[h],
                            max(qn_data$occ_dad[h],qn_data$occ_mum[h]),
                            max(qn_data$mum_ed_rec[h],qn_data$dad_ed_rec[h]))
    }
     
  
# Remove extra SES data columns
  qn_data = subset(qn_data, select=-c(mum_occup_ISCO,dad_occup_ISCO, income, mum_ed, dad_ed, occ_mum, occ_dad, income_rec, dad_ed_rec, mum_ed_rec))  
  
# Calculate change scores (d = delta) for T2
  qn_data$d_GEM_Total = qn_data$GEM_Total_T2 - qn_data$GEM_Total_T1
  qn_data$d_EMK_EM_CH = qn_data$EMK_EM_CH_T2 - qn_data$EMK_EM_CH_T1
  qn_data$d_EMK_EM_P = qn_data$EMK_EM_P_T2 - qn_data$EMK_EM_P_T1
  qn_data$d_EMK_EK_CH = qn_data$EMK_EK_CH_T2 - qn_data$EMK_EK_CH_T1
  qn_data$d_EMK_EK_P = qn_data$EMK_EK_P_T2 - qn_data$EMK_EK_P_T1
  qn_data$d_EMK_PB_CH = qn_data$EMK_PB_CH_T2 - qn_data$EMK_PB_CH_T1
  qn_data$d_SDQ_PB = qn_data$SDQ_PB_T2 - qn_data$SDQ_PB_T1
  qn_data$d_SDQ_Total = qn_data$SDQ_Total_T1 - qn_data$SDQ_Total_T2

  
# Invert parental involvement
  qn_data$P_invo_rec = ifelse(qn_data$P_invo == 1, 5, 
          ifelse(qn_data$P_invo == 2, 4,
          ifelse(qn_data$P_invo == 3, 3,
          ifelse(qn_data$P_invo == 4,2, 
          ifelse(qn_data$P_invo == 5,1,99)))))
  

  save(qn_data, file = "./data/qn_data.RData")  
  
```

# ERT

* Get mean accuracy per intensity condition

**Exclusion of participants:**

* Collect info from data collection sheet
  + Exclude: 19, 23, 39, 57 (pressed button randomly)
  
* Look at individual data
  + Questions: Does someone has very high / low RTs / Acc?
  + Not following linear increase (wrong button coding, fixed in script): 
  + happy: 1, 3, 8, 10, 11, 18, 20-22, 24, 25, 27-29, 36, 41, 42, 44, 45, 46, 48, 49-51, 54, 55, 58, 61, 62, 63, 65, 66, 69, 73, 74, 75, 76
* Very low accuracy:
  + happy: 44, 73
  + angry: 21
  
**Exclusion of values:**

* Reaction times too fast < 250 ms  (Johnston et al., 2011)
  
```{r ERT_data_LMM}

#### Get raw data 

# Get file names
  file_list = as_tibble(list.files(path = "./data/ERT/", pattern = "*.csv", all.files = FALSE))

# Create block info (60 trials per block; 2 blocks, 1 emotion per block (happy vs. angry))
  emo = rep(1:2, each=60)

# Run loop to merge all participants' data
  
  for (i in 1:nrow(file_list)) {
    
    if (i != 25) { # participants 26 EMT had to be aborted, hence exclusion
  
    # Load data
      part = as_tibble(read.csv(paste("./data/ERT/",file_list[i,1], sep = ""))) 
      # sep = no space between words
    
    # Define N/A data
      part[part=="NaN"] = NA
    
    # Add ID
      part$ID = substr(file_list[i,1],1,2)
      
    # Rename columns
      part = dplyr::rename(part, stim = Image_1,
                            intens = emotion,
                            response = Answer,
                            RT = RT_in_ms)
      
    # Add emotion info
      part$emo = emo
      
    # Re-locate stimulus info to back of columns  
      part =
      part %>%
        relocate(stim, .after = RT) %>%
        relocate(ID) %>%
        relocate(emo, .after = ID) 
      
      
    # Transform seconds to mseconds
      part$RT = part$RT*1000
      
    # Exclude values < 250 ms
      part = subset(part, RT > 250)
      
    # Combine datasets
      
      if (i == 1) {
        
        # Recode button order for block with happy faces
        part$response[part$emo == 2] = dplyr::recode(part$response[part$emo == 2], `0` = 1, `1` = 0)
        ERT_data = part
        
      } else {
        
        # Re-code happy block (some participants had wrong button order)
          if (i == 1 | i == 3 | i == 7 | i == 9 | i == 10| i == 17 | 
              i == 19 | i == 20| i == 21 | i == 23 | i == 24| i == 26 |
              i == 27 | i == 28 | i == 35 | i == 40 | i == 41| i == 43 |
              i == 44 | i == 45 | i == 47 | i == 48| i == 49| 
              i == 50 | i == 53 | i == 54 | i == 57| i == 60| i == 61 | 
              i == 62 | i == 64| i == 65| i == 66 | i == 68| i == 69 | i == 70| i == 71
              ){

            part$response[part$emo == 2] = dplyr::recode(part$response[part$emo == 2], `0` = 1, `1` = 0)

          }
    
        ERT_data = rbind(ERT_data, part)
      }
      
      remove(part)
  }
  }
  
# Re-code intensity levels / emo  
  ERT_data$emo[ERT_data$emo == 1] = "angry"
  ERT_data$emo[ERT_data$emo == 2] = "happy"

  ERT_data$intens[ERT_data$intens== "hap20"] = "20%"
  ERT_data$intens[ERT_data$intens== "hap40"] = "40%"
  ERT_data$intens[ERT_data$intens== "hap60"] = "60%"
  ERT_data$intens[ERT_data$intens== "hap80"] = "80%"
  ERT_data$intens[ERT_data$intens== "hap100"] = "100%"
  
  ERT_data$intens[ERT_data$intens== "ang20"] = "20%"
  ERT_data$intens[ERT_data$intens== "ang40"] = "40%"
  ERT_data$intens[ERT_data$intens== "ang60"] = "60%"
  ERT_data$intens[ERT_data$intens== "ang80"] = "80%"
  ERT_data$intens[ERT_data$intens== "ang100"] = "100%" 
  
# Factor intensity
  ERT_data$intens = factor(ERT_data$intens, levels = c("neu", "20%", "40%", "60%", "80%", "100%"))
  
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#### Add questionnaire data  
    
# Add column to include participants (exclusion reason: non-compliance --> grad)
  
# Load qn_data
  load.Rdata(filename="./data/qn_data.Rdata", "qn_data")
  
# Adapt ID structure in qn_data
  qn_data$ID = c(paste0("0", 1:9), 10:76)
  
# Match with parental / self-report measures 
  ERT_data$group = qn_data$group[match(ERT_data$ID,qn_data$ID,nomatch = NA)]

# Factor group levels
  ERT_data$group = factor(ERT_data$group)
  
# Save data  
  save(ERT_data, file = "./data/ERT_data.RData") 

```

```{r ERT_data_ANOVA}

# Set number of trials per condition (120 total, 20 for neutral (10 per block), 10 per emotion intensity)
  ntrials = 10

# Calculate n_hit (response = 1) and n_fa (false alarms, response = 0) n_miss ( response = NA) rates, RT
  ERT_means =
  ERT_data %>%
  dplyr::group_by(ID, intens, emo) %>% 
  dplyr::summarise(n_hit = sum(response, na.rm = TRUE),
            perc_hit = n_hit/ntrials,
            n_fa = sum(response == 0, na.rm = TRUE),
            perc_fa = n_fa/ntrials,
            n_miss = sum(is.na(response)),
            RT = mean(RT, na.rm = TRUE))
  
# Match with parental / self-report measures 
  ERT_means$part_incl = qn_data$part_incl[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$group = qn_data$group[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$sex = qn_data$sex[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  
  ERT_means$age = qn_data$age[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$med_age = qn_data$med_age[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$CPM = qn_data$CPM[match(ERT_means$ID,qn_data$ID,nomatch = NA)] 
  
  ERT_means$GEM_T2 = qn_data$GEM_Total_T2[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$EMK_EM_P_T2 = qn_data$EMK_EM_P_T2[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$EMK_EM_CH_T2 = qn_data$EMK_EM_CH_T2[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$EMK_EK_P_T2 = qn_data$EMK_EK_P_T2[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$EMK_EK_CH_T2 = qn_data$EMK_EK_CH_T2[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$EMK_PB_CH_T2 = qn_data$EMK_PB_CH_T2[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$SDQ_PB_T2 = qn_data$SDQ_PB_T2[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$SDQ_T2 = qn_data$SDQ_Total_T2[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  
# Save data
  save(ERT_means, file = "./data/ERT_means.RData") 
  
```

# Max-face data frequency

```{r max_data}

# Load qn_data
  load.Rdata(filename="./data/qn_data.RData", "qn_data")

# Exclude (EEG_Max = 0) participants with no eligible FPVS max-face data
  qn_data = subset(qn_data, EEG_Max == 1)

# Get baseline-corrected amplitude (bca) data
  base_hap = read.delim("./data/max_bca_base_hap.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
  base_ang = read.delim("./data/max_bca_base_ang.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
  expr_hap = read.delim("./data/max_bca_expr_hap.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
  expr_ang = read.delim("./data/max_bca_expr_ang.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
  
# Add ID
  base_ang$ID = qn_data$ID
  base_hap$ID = qn_data$ID 
  expr_ang$ID = qn_data$ID
  expr_hap$ID = qn_data$ID    
    
# Add emotion info and base/odd info (manip = manipulation)
  base_ang = mutate(base_ang, emotion = "angry", manip = "base")
  base_hap = mutate(base_hap, emotion = "happy", manip = "base")
  expr_ang = mutate(expr_ang, emotion = "angry", manip = "expr")
  expr_hap = mutate(expr_hap, emotion = "happy", manip = "expr")
    
# Merge data frames together
  max = bind_rows(base_ang, base_hap, expr_ang, expr_hap)
  
# Re-order data frame
  max = subset(max, select=c(ID, emotion, manip, Fp1:Oz))
  
### Select channels / average across ROIs
    
# Select only channels of interest
  max_ROI = subset(max, select=c(ID, emotion, manip, O1, O2, Oz, P3,
                                 PO7, PO3, PO4, P4, PO8, PO9, PO10, P7, P8))

# Select base condition
  max_base = subset(max_ROI, manip == "base")

# Average for selected ROIs
  max_base = dplyr::mutate(max_base,
                        MO = rowMeans(max_base[,c("O1","O2","Oz")], na.rm=TRUE),
                        lOT = rowMeans(max_base[,c("PO3", "PO7","PO9","P7")], na.rm=TRUE),
                        rOT = rowMeans(max_base[,c("PO4", "PO8","PO10","P8")], na.rm=TRUE))
  

# Select odd condition
  max_odd = subset(max_ROI, manip == "expr")

# Average for selected ROIs
  max_odd = dplyr::mutate(max_odd,
                        MO = rowMeans(max_odd[,c("O1", "O2","Oz")], na.rm=TRUE),
                        lOT = rowMeans(max_odd[,c("PO3", "PO7","PO9","P7")], na.rm=TRUE),
                        rOT = rowMeans(max_odd[,c("PO4", "PO8","PO10","P8")], na.rm=TRUE))

### Select and prepare data for plotting

# Chose ROIs only
  max_expr_plot = subset(max_odd, select=c(ID, emotion, MO, lOT, rOT))
  max_base_plot = subset(max_base, select=c(ID, emotion, MO, lOT, rOT))

# Transform from wide to long format
  max_expr_plot = gather(max_expr_plot, ROI, bca, MO:rOT, factor_key=TRUE)
  max_base_plot = gather(max_base_plot, ROI, bca, MO:rOT, factor_key=TRUE)
 
  
### Select and prepare data for plotting
  
# Chose ROIs only   
  max_expr_plot = subset(max_odd, select=c(ID, emotion, MO, lOT, rOT))
  max_base_plot = subset(max_base, select=c(ID, emotion, MO, lOT, rOT))
  
# Transform from wide to long format 
  max_expr_plot = gather(max_expr_plot, ROI, bca, MO,lOT:rOT, factor_key=TRUE)
  max_base_plot = gather(max_base_plot, ROI, bca, MO,lOT:rOT, factor_key=TRUE)  
  
# Add demographics 
  max_base_plot$group = qn_data$group[match(max_base_plot$ID,qn_data$ID,nomatch = NA)]
  max_base_plot$sex = qn_data$sex[match(max_base_plot$ID,qn_data$ID,nomatch = NA)]
  max_base_plot$age = qn_data$age[match(max_base_plot$ID,qn_data$ID,nomatch = NA)]  
  max_base_plot$SNR_ex = qn_data$Vis_SNR_Max[match(max_base_plot$ID,qn_data$ID,nomatch = NA)]  
  
# Add demographics 
  max_expr_plot$group = qn_data$group[match(max_expr_plot$ID,qn_data$ID,nomatch = NA)]
  max_expr_plot$sex = qn_data$sex[match(max_expr_plot$ID,qn_data$ID,nomatch = NA)]
  max_expr_plot$age = qn_data$age[match(max_expr_plot$ID,qn_data$ID,nomatch = NA)]  
  max_expr_plot$SNR_ex = qn_data$Vis_SNR_Max[match(max_expr_plot$ID,qn_data$ID,nomatch = NA)]  
  
# Save in Rdata format
  save(max_base_plot, file = "./data/max_base_plot.RData")
  save(max_expr_plot, file = "./data/max_expr_plot.RData")
  
## Topographies  
  
# Select data   
  max_topo = subset(max, select=c(ID, manip, emotion, Fp1:Oz))
    
# Add time variable  
  max_topo = mutate(max_topo, time = 1)
      
# Change from wide to long format for electrodes
  max_topo = gather(max_topo, electrode, amplitude, Fp1:Oz, factor_key=TRUE)
  
# Save in Rdata format
  save(max_topo, file = "./data/max_topo.RData")
  
### Select and prepare data for statistical analysis
  
# Select ROIs
  max_expr_stats = subset(max_odd, select=c(ID, emotion, MO, lOT, rOT))
  max_base_stats = subset(max_base, select=c(ID, emotion, MO, lOT, rOT))

# Change format from wide to long
  max_expr_stats = max_expr_stats %>%
  gather(key = "ROI", value = "bca", MO, lOT, rOT) %>%
  convert_as_factor(ID, ROI, emotion)
  
  
# Add demographics 
  max_expr_stats$group = qn_data$group[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$sex = qn_data$sex[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$age = qn_data$age[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]   
  max_expr_stats$SNR_ex = qn_data$Vis_SNR_Max[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)] 
  
  max_expr_stats$SRS = qn_data$SRS_T2[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$GEM_T2 = qn_data$GEM_Total_T2[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$EMK_EM_P_T2 = qn_data$EMK_EM_P_T2[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$EMK_EM_CH_T2 = qn_data$EMK_EM_CH_T2[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$EMK_EK_P_T2 = qn_data$EMK_EK_P_T2[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$EMK_EK_CH_T2 = qn_data$EMK_EK_CH_T2[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$EMK_PB_CH_T2 = qn_data$EMK_PB_CH_T2[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$SDQ_PB_T2 = qn_data$SDQ_PB_T2[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$SDQ_T2 = qn_data$SDQ_Total_T2[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]

  max_expr_stats$d_GEM_Total = qn_data$d_GEM_Total[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$d_EMK_EM_CH = qn_data$d_EMK_EM_CH[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$d_EMK_EM_P = qn_data$d_EMK_EM_P[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$d_EMK_EK_CH = qn_data$d_EMK_EK_CH[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$d_EMK_EK_P = qn_data$d_EMK_EK_P[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$d_EMK_PB_CH = qn_data$d_EMK_PB_CH[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$d_SDQ_PB = qn_data$d_SDQ_PB[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$d_SDQ_Total = qn_data$d_SDQ_Total[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  
# Change format from wide to long
  max_base_stats = max_base_stats %>%
  gather(key = "ROI", value = "bca", MO, lOT, rOT) %>%
  convert_as_factor(ID, ROI, emotion)
  
# Add demographics   
  max_base_stats$group = qn_data$group[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$sex = qn_data$sex[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$age = qn_data$age[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]  
  max_base_stats$SNR_ex = qn_data$Vis_SNR_Max[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]  

  max_base_stats$SRS = qn_data$SRS_T2[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$GEM_T2 = qn_data$GEM_Total_T2[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$EMK_EM_P_T2 = qn_data$EMK_EM_P_T2[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$EMK_EM_CH_T2 = qn_data$EMK_EM_CH_T2[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$EMK_EK_P_T2 = qn_data$EMK_EK_P_T2[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$EMK_EK_CH_T2 = qn_data$EMK_EK_CH_T2[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$EMK_PB_CH_T2 = qn_data$EMK_PB_CH_T2[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$SDQ_PB_T2 = qn_data$SDQ_PB_T2[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$SDQ_T2 = qn_data$SDQ_Total_T2[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]

  max_base_stats$d_GEM_Total = qn_data$d_GEM_Total[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$d_EMK_EM_CH = qn_data$d_EMK_EM_CH[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$d_EMK_EM_P = qn_data$d_EMK_EM_P[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$d_EMK_EK_CH = qn_data$d_EMK_EK_CH[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$d_EMK_EK_P = qn_data$d_EMK_EK_P[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$d_EMK_PB_CH = qn_data$d_EMK_PB_CH[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$d_SDQ_PB = qn_data$d_SDQ_PB[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$d_SDQ_Total = qn_data$d_SDQ_Total[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  
# Save in Rdata format
  save(max_base_stats, file = "./data/max_base_stats.RData")
  save(max_expr_stats, file = "./data/max_expr_stats.RData")
  
  
```

# Max-face data frequency pdi

```{r max_data_pdi}

# Load qn_data
  load.Rdata(filename="./data/qn_data.RData", "qn_data")

# Exclude (EEG_Max = 0) participants with no eligible FPVS max-face data
  qn_data = subset(qn_data, EEG_Max == 1)

# Get baseline-corrected amplitude (bca) data
  base_hap = read.delim("./data/max_pdi_base_hap.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
  base_ang = read.delim("./data/max_pdi_base_ang.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
  expr_hap = read.delim("./data/max_pdi_expr_hap.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
  expr_ang = read.delim("./data/max_pdi_expr_ang.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
  
# Add ID
  base_ang$ID = qn_data$ID
  base_hap$ID = qn_data$ID 
  expr_ang$ID = qn_data$ID
  expr_hap$ID = qn_data$ID    
    
# Add emotion info and base/odd info (manip = manipulation)
  base_ang = mutate(base_ang, emotion = "angry", manip = "base")
  base_hap = mutate(base_hap, emotion = "happy", manip = "base")
  expr_ang = mutate(expr_ang, emotion = "angry", manip = "expr")
  expr_hap = mutate(expr_hap, emotion = "happy", manip = "expr")
    
# Merge data frames together
  max = bind_rows(base_ang, base_hap, expr_ang, expr_hap)
  
# Re-order data frame
  max = subset(max, select=c(ID, emotion, manip, Fp1:Oz))
  
### Select channels / average across ROIs
    
# Select only channels of interest
  max_ROI = subset(max, select=c(ID, emotion, manip, O1, O2, Oz, P3,
                                 PO7, PO3, PO4, P4, PO8, PO9, PO10, P7, P8))

# Select base condition
  max_base = subset(max_ROI, manip == "base")

# Average for selected ROIs
  max_base = dplyr::mutate(max_base,
                        MO = rowMeans(max_base[,c("O1","O2","Oz")], na.rm=TRUE),
                        lOT = rowMeans(max_base[,c("PO3", "PO7","PO9","P7")], na.rm=TRUE),
                        rOT = rowMeans(max_base[,c("PO4", "PO8","PO10","P8")], na.rm=TRUE))
  

# Select odd condition
  max_odd = subset(max_ROI, manip == "expr")

# Average for selected ROIs
  max_odd = dplyr::mutate(max_odd,
                        MO = rowMeans(max_odd[,c("O1", "O2","Oz")], na.rm=TRUE),
                        lOT = rowMeans(max_odd[,c("PO3", "PO7","PO9","P7")], na.rm=TRUE),
                        rOT = rowMeans(max_odd[,c("PO4", "PO8","PO10","P8")], na.rm=TRUE))

### Select and prepare data for plotting

# Chose ROIs only
  max_expr_plot = subset(max_odd, select=c(ID, emotion, MO, lOT, rOT))
  max_base_plot = subset(max_base, select=c(ID, emotion, MO, lOT, rOT))

# Transform from wide to long format
  max_expr_plot = gather(max_expr_plot, ROI, bca, MO:rOT, factor_key=TRUE)
  max_base_plot = gather(max_base_plot, ROI, bca, MO:rOT, factor_key=TRUE)
 
  
### Select and prepare data for plotting
  
# Chose ROIs only   
  max_expr_plot = subset(max_odd, select=c(ID, emotion, MO, lOT, rOT))
  max_base_plot = subset(max_base, select=c(ID, emotion, MO, lOT, rOT))
  
# Transform from wide to long format 
  max_expr_plot = gather(max_expr_plot, ROI, bca, MO,lOT:rOT, factor_key=TRUE)
  max_base_plot = gather(max_base_plot, ROI, bca, MO,lOT:rOT, factor_key=TRUE)  
  
# Add demographics 
  max_base_plot$group = qn_data$group[match(max_base_plot$ID,qn_data$ID,nomatch = NA)]
  max_base_plot$sex = qn_data$sex[match(max_base_plot$ID,qn_data$ID,nomatch = NA)]
  max_base_plot$age = qn_data$age[match(max_base_plot$ID,qn_data$ID,nomatch = NA)]  
  max_base_plot$SNR_ex = qn_data$Vis_SNR_Max[match(max_base_plot$ID,qn_data$ID,nomatch = NA)]  
  
# Add demographics 
  max_expr_plot$group = qn_data$group[match(max_expr_plot$ID,qn_data$ID,nomatch = NA)]
  max_expr_plot$sex = qn_data$sex[match(max_expr_plot$ID,qn_data$ID,nomatch = NA)]
  max_expr_plot$age = qn_data$age[match(max_expr_plot$ID,qn_data$ID,nomatch = NA)]  
  max_expr_plot$SNR_ex = qn_data$Vis_SNR_Max[match(max_expr_plot$ID,qn_data$ID,nomatch = NA)]  
  
# Save in Rdata format
  save(max_base_plot, file = "./data/max_base_plot_pdi.RData")
  save(max_expr_plot, file = "./data/max_expr_plot_pdi.RData")
  
## Topographies  
  
# Select data   
  max_topo = subset(max, select=c(ID, manip, emotion, Fp1:Oz))
    
# Add time variable  
  max_topo = mutate(max_topo, time = 1)
      
# Change from wide to long format for electrodes
  max_topo = gather(max_topo, electrode, amplitude, Fp1:Oz, factor_key=TRUE)
  
# Save in Rdata format
  save(max_topo, file = "./data/max_topo.RData")
  
### Select and prepare data for statistical analysis
  
# Select ROIs
  max_expr_stats = subset(max_odd, select=c(ID, emotion, MO, lOT, rOT))
  max_base_stats = subset(max_base, select=c(ID, emotion, MO, lOT, rOT))

# Change format from wide to long
  max_expr_stats = max_expr_stats %>%
  gather(key = "ROI", value = "bca", MO, lOT, rOT) %>%
  convert_as_factor(ID, ROI, emotion)
  
  
# Add demographics 
  max_expr_stats$group = qn_data$group[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$sex = qn_data$sex[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$age = qn_data$age[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]   
  max_expr_stats$SNR_ex = qn_data$Vis_SNR_Max[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)] 
  
  max_expr_stats$SRS = qn_data$SRS_T2[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$GEM_T2 = qn_data$GEM_Total_T2[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$EMK_EM_P_T2 = qn_data$EMK_EM_P_T2[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$EMK_EM_CH_T2 = qn_data$EMK_EM_CH_T2[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$EMK_EK_P_T2 = qn_data$EMK_EK_P_T2[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$EMK_EK_CH_T2 = qn_data$EMK_EK_CH_T2[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$EMK_PB_CH_T2 = qn_data$EMK_PB_CH_T2[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$SDQ_PB_T2 = qn_data$SDQ_PB_T2[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$SDQ_T2 = qn_data$SDQ_Total_T2[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]

  max_expr_stats$d_GEM_Total = qn_data$d_GEM_Total[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$d_EMK_EM_CH = qn_data$d_EMK_EM_CH[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$d_EMK_EM_P = qn_data$d_EMK_EM_P[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$d_EMK_EK_CH = qn_data$d_EMK_EK_CH[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$d_EMK_EK_P = qn_data$d_EMK_EK_P[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$d_EMK_PB_CH = qn_data$d_EMK_PB_CH[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$d_SDQ_PB = qn_data$d_SDQ_PB[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  max_expr_stats$d_SDQ_Total = qn_data$d_SDQ_Total[match(max_expr_stats$ID,qn_data$ID,nomatch = NA)]
  
# Change format from wide to long
  max_base_stats = max_base_stats %>%
  gather(key = "ROI", value = "bca", MO, lOT, rOT) %>%
  convert_as_factor(ID, ROI, emotion)
  
# Add demographics   
  max_base_stats$group = qn_data$group[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$sex = qn_data$sex[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$age = qn_data$age[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]  
  max_base_stats$SNR_ex = qn_data$Vis_SNR_Max[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]  

  max_base_stats$SRS = qn_data$SRS_T2[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$GEM_T2 = qn_data$GEM_Total_T2[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$EMK_EM_P_T2 = qn_data$EMK_EM_P_T2[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$EMK_EM_CH_T2 = qn_data$EMK_EM_CH_T2[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$EMK_EK_P_T2 = qn_data$EMK_EK_P_T2[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$EMK_EK_CH_T2 = qn_data$EMK_EK_CH_T2[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$EMK_PB_CH_T2 = qn_data$EMK_PB_CH_T2[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$SDQ_PB_T2 = qn_data$SDQ_PB_T2[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$SDQ_T2 = qn_data$SDQ_Total_T2[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]

  max_base_stats$d_GEM_Total = qn_data$d_GEM_Total[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$d_EMK_EM_CH = qn_data$d_EMK_EM_CH[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$d_EMK_EM_P = qn_data$d_EMK_EM_P[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$d_EMK_EK_CH = qn_data$d_EMK_EK_CH[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$d_EMK_EK_P = qn_data$d_EMK_EK_P[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$d_EMK_PB_CH = qn_data$d_EMK_PB_CH[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$d_SDQ_PB = qn_data$d_SDQ_PB[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  max_base_stats$d_SDQ_Total = qn_data$d_SDQ_Total[match(max_base_stats$ID,qn_data$ID,nomatch = NA)]
  
# Save in Rdata format
  save(max_base_stats, file = "./data/max_base_stats_pdi.RData")
  save(max_expr_stats, file = "./data/max_expr_stats_pdi.RData")
  
  
```

# Max-face data time-domain

```{r max_data_time}

# Load data
   P1_amp_lat = read.delim("./data/max_P1_amp_lat.txt", header = TRUE, sep = " ", dec = ".") 
   N170_amp_lat = read.delim("./data/max_N170_amp_lat.txt", header = TRUE, sep = " ", dec = ".") 
   P3_amp_lat = read.delim("./data/max_P3_amp_lat.txt", header = TRUE, sep = " ", dec = ".") 
    
# Average across ROI  for mean amplitudes / peak latencies
  P1_av = data.frame(ID = P1_amp_lat[,23],
                                        emotion = P1_amp_lat[,24],
                                        lOT = rowMeans(P1_amp_lat[,c(4,5,6,7)]),
                                        rOT = rowMeans(P1_amp_lat[,c(8,9,10,11)]),
                                        MO = rowMeans(P1_amp_lat[,1:3]))
  
  P1_av_lat = data.frame(ID = P1_amp_lat[,23],
                                        emotion = P1_amp_lat[,24],
                                        lOT = rowMeans(P1_amp_lat[,c(15,16,17,18)]),
                                        rOT = rowMeans(P1_amp_lat[,c(19,20,21,22)]),
                                        MO = rowMeans(P1_amp_lat[,12:14]))
  
# Make ROI factor 
  P1_av = gather(P1_av, ROI, amp, lOT:MO,factor_key=TRUE)
  P1_av_lat = gather(P1_av_lat, ROI, lat, lOT:MO,factor_key=TRUE)

# Add latency to amplitude
  P1_av$lat = P1_av_lat$lat
  
# Add group
  P1_av$group = qn_data$group[match(P1_av$ID,qn_data$ID,nomatch = NA)]
  
# Recode emotion
  P1_av$emotion[P1_av$emotion == 1] = "happy"
  P1_av$emotion[P1_av$emotion == 2] = "angry"   
  
  
# Average across ROI  for mean amplitudes / peak latencies
  N170_av = data.frame(ID = N170_amp_lat[,23],
                                        emotion = N170_amp_lat[,24],
                                        lOT = rowMeans(N170_amp_lat[,c(4,5,6,7)]),
                                        rOT = rowMeans(N170_amp_lat[,c(8,9,10,11)]),
                                        MO = rowMeans(N170_amp_lat[,1:3]))
  
  N170_av_lat = data.frame(ID = N170_amp_lat[,23],
                                        emotion = N170_amp_lat[,24],
                                        lOT = rowMeans(N170_amp_lat[,c(15,16,17,18)]),
                                        rOT = rowMeans(N170_amp_lat[,c(19,20,21,22)]),
                                        MO = rowMeans(N170_amp_lat[,12:14]))
  
# Make ROI factor 
  N170_av = gather(N170_av, ROI, amp, lOT:MO,factor_key=TRUE)
  N170_av_lat = gather(N170_av_lat, ROI, lat, lOT:MO,factor_key=TRUE)

# Add latency to amplitude
  N170_av$lat = N170_av_lat$lat
  
# Add group
  N170_av$group = qn_data$group[match(N170_av$ID,qn_data$ID,nomatch = NA)]
  
# Recode emotion
  N170_av$emotion[N170_av$emotion == 1] = "happy"
  N170_av$emotion[N170_av$emotion == 2] = "angry"    
  
    
# Average across ROI  for mean amplitudes / peak latencies
  P3_av = data.frame(ID = P3_amp_lat[,23],
                                        emotion = P3_amp_lat[,24],
                                        lOT = rowMeans(P3_amp_lat[,c(4,5,6)]),
                                        rOT = rowMeans(P3_amp_lat[,c(8,9,10)]),
                                        MO = rowMeans(P3_amp_lat[,1:3]))
  
  P3_av_lat = data.frame(ID = P3_amp_lat[,23],
                                        emotion = P3_amp_lat[,24],
                                        lOT = rowMeans(P3_amp_lat[,c(15,16,18)]),
                                        rOT = rowMeans(P3_amp_lat[,c(19,20,22)]),
                                        MO = rowMeans(P3_amp_lat[,12:14]))
  
# Make ROI factor 
  P3_av = gather(P3_av, ROI, amp, lOT:MO,factor_key=TRUE)
  P3_av_lat = gather(P3_av_lat, ROI, lat, lOT:MO,factor_key=TRUE)

# Add latency to amplitude
  P3_av$lat = P3_av_lat$lat
  
# Add group
  P3_av$group = qn_data$group[match(P3_av$ID,qn_data$ID,nomatch = NA)]
  
# Recode emotion
  P3_av$emotion[P3_av$emotion == 1] = "happy"
  P3_av$emotion[P3_av$emotion == 2] = "angry"     
  
  
# Save in Rdata format
  save(P1_av, file = "./data/P1_av.RData")
  save(N170_av, file = "./data/N170_av.RData") 
  save(P3_av, file = "./data/P3_av.RData") 
  
```

# Grad-face data frequency

```{r grad_data_freq}

# Load qn_data
  load.Rdata(filename="./data/qn_data.RData", "qn_data")

# Exclude (EEG_Grad = 0) participants with no eligible FPVS grad-face data
  qn_data_grad = subset(qn_data, EEG_Grad == 1)

# Get baseline-corrected amplitude (bca) data

  # Base rate  
    base_hap_twent = read.delim("./data/grad_bca_base_hap_twent.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    base_hap_fort = read.delim("./data/grad_bca_base_hap_fort.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    base_hap_sixt = read.delim("./data/grad_bca_base_hap_sixt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    base_hap_eigt = read.delim("./data/grad_bca_base_hap_eigt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    base_hap_oneh = read.delim("./data/grad_bca_base_hap_oneh.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    
    base_ang_twent = read.delim("./data/grad_bca_base_ang_twent.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    base_ang_fort = read.delim("./data/grad_bca_base_ang_fort.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    base_ang_sixt = read.delim("./data/grad_bca_base_ang_sixt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    base_ang_eigt = read.delim("./data/grad_bca_base_ang_eigt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    base_ang_oneh = read.delim("./data/grad_bca_base_ang_oneh.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    
  # Expression change 
    expr_hap_twent = read.delim("./data/grad_bca_expr_hap_twent.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    expr_hap_fort = read.delim("./data/grad_bca_expr_hap_fort.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    expr_hap_sixt = read.delim("./data/grad_bca_expr_hap_sixt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    expr_hap_eigt = read.delim("./data/grad_bca_expr_hap_eigt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    expr_hap_oneh = read.delim("./data/grad_bca_expr_hap_oneh.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    
    expr_ang_twent = read.delim("./data/grad_bca_expr_ang_twent.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    expr_ang_fort = read.delim("./data/grad_bca_expr_ang_fort.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    expr_ang_sixt = read.delim("./data/grad_bca_expr_ang_sixt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    expr_ang_eigt = read.delim("./data/grad_bca_expr_ang_eigt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    expr_ang_oneh = read.delim("./data/grad_bca_expr_ang_oneh.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    
# Add intensity 
  # Base rate 
  base_hap_twent = mutate(base_hap_twent, ID = qn_data_grad$ID, emotion = "happy", intens = "20%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   
   base_hap_fort = mutate(base_hap_fort, ID = qn_data_grad$ID, emotion = "happy", intens = "40%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   base_hap_sixt = mutate(base_hap_sixt, ID = qn_data_grad$ID, emotion = "happy", intens = "60%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   base_hap_eigt = mutate(base_hap_eigt, ID = qn_data_grad$ID, emotion = "happy", intens = "80%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   base_hap_oneh = mutate(base_hap_oneh, ID = qn_data_grad$ID, emotion = "happy", intens = "100%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)  
    
    
   base_ang_twent = mutate(base_ang_twent, ID = qn_data_grad$ID, emotion = "angry", intens = "20%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   
   base_ang_fort = mutate(base_ang_fort, ID = qn_data_grad$ID, emotion = "angry", intens = "40%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   base_ang_sixt = mutate(base_ang_sixt, ID = qn_data_grad$ID, emotion = "angry", intens = "60%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   base_ang_eigt = mutate(base_ang_eigt, ID = qn_data_grad$ID, emotion = "angry", intens = "80%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   base_ang_oneh = mutate(base_ang_oneh, ID = qn_data_grad$ID, emotion = "angry", intens = "100%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
    
  # Expression change 
  expr_hap_twent = mutate(expr_hap_twent, ID = qn_data_grad$ID, emotion = "happy", intens = "20%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   
   expr_hap_fort = mutate(expr_hap_fort, ID = qn_data_grad$ID, emotion = "happy", intens = "40%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   expr_hap_sixt = mutate(expr_hap_sixt, ID = qn_data_grad$ID, emotion = "happy", intens = "60%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   expr_hap_eigt = mutate(expr_hap_eigt, ID = qn_data_grad$ID, emotion = "happy", intens = "80%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   expr_hap_oneh = mutate(expr_hap_oneh, ID = qn_data_grad$ID, emotion = "happy", intens = "100%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)  
    
    
   expr_ang_twent = mutate(expr_ang_twent, ID = qn_data_grad$ID, emotion = "angry", intens = "20%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   
   expr_ang_fort = mutate(expr_ang_fort, ID = qn_data_grad$ID, emotion = "angry", intens = "40%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   expr_ang_sixt = mutate(expr_ang_sixt, ID = qn_data_grad$ID, emotion = "angry", intens = "60%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   expr_ang_eigt = mutate(expr_ang_eigt, ID = qn_data_grad$ID, emotion = "angry", intens = "80%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   expr_ang_oneh = mutate(expr_ang_oneh, ID = qn_data_grad$ID, emotion = "angry", intens = "100%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
# Merge data frames together
  grad = bind_rows(
    base_hap_twent,base_hap_fort,base_hap_sixt, base_hap_eigt, base_hap_oneh,
    base_ang_twent,base_ang_fort,base_ang_sixt, base_ang_eigt, base_ang_oneh,
    expr_hap_twent,expr_hap_fort,expr_hap_sixt, expr_hap_eigt, expr_hap_oneh,
    expr_ang_twent,expr_ang_fort,expr_ang_sixt, expr_ang_eigt, expr_ang_oneh)
  
# Re-order data frame
  grad = subset(grad, select=c(ID, age, sex, group, emotion, manip, intens, Fp1:Oz))
 
# Re-factor variables of interest   
   grad$intens = factor(grad$intens, levels = c("20%", "40%", "60%","80%","100%"))
   grad$emotion = factor(grad$emotion, levels = c("happy","angry"))

   
# Select only channels of interest
  grad_ROI = subset(grad, select=c(ID, age, sex, group, emotion, intens, manip, O1, O2, Oz, PO3,
                                  PO7, P7, PO9, PO4, PO8, P8, PO10))
# Select base condition
  grad_base = subset(grad_ROI, manip == "base")

# Average base response for selected ROIs
  grad_base = dplyr::mutate(grad_base,
                        MO = rowMeans(grad_base[,c("O1", "O2", "Oz")], na.rm=TRUE),
                        lOT = rowMeans(grad_base[,c("P7", "PO7", "PO9", "PO3")], na.rm=TRUE),
                        rOT = rowMeans(grad_base[,c("P8", "PO8", "PO10", "PO4")], na.rm=TRUE))

# Select expression change condition
  grad_expr = subset(grad_ROI, manip == "expr")

# Average expression change response for selected ROIs
  grad_expr = dplyr::mutate(grad_expr,
                         MO = rowMeans(grad_expr[,c("O1", "O2", "Oz")], na.rm=TRUE),
                         lOT = rowMeans(grad_expr[,c("P7", "PO7", "PO9", "PO3")], na.rm=TRUE),
                         rOT = rowMeans(grad_expr[,c("P8", "PO8", "PO10", "PO4")], na.rm=TRUE))

## For bar plots 
  
# Select ROIs
  grad_expr_plot = subset(grad_expr, select=c(ID, emotion, intens, group, MO, lOT, rOT))
  grad_base_plot = subset(grad_base, select=c(ID, emotion, intens, group, MO, lOT, rOT))

# Transform from wide to long format
  grad_expr_plot = gather(grad_expr_plot, ROI, bca, MO:rOT, factor_key=TRUE)
  grad_base_plot = gather(grad_base_plot, ROI, bca, MO:rOT, factor_key=TRUE)
  
# Save in Rdata format
  save(grad_base_plot, file = "./data/grad_base_plot.RData")
  save(grad_expr_plot, file = "./data/grad_expr_plot.RData")  

## Topographies

# Select data
  grad_topo = subset(grad, select=c(ID, manip, emotion, group, intens, Fp1:Oz))

# Add time variable
  grad_topo = mutate(grad_topo, time = 1)

# Change from wide to long format for electrodes
  grad_topo = gather(grad_topo, electrode, amplitude, Fp1:Oz, factor_key=TRUE)  
  
# Save in Rdata format
  save(grad_topo, file = "./data/grad_topo.RData")
 
## For stats   
  
# Select ROIs
  grad_base_stats = subset(grad_base, select=c(ID, emotion, group, intens, MO, lOT, rOT))
  grad_expr_stats = subset(grad_expr, select=c(ID, emotion, group, intens, MO, lOT, rOT))

# Change format from wide to long
  grad_base_stats = grad_base_stats %>%
  gather(key = "ROI", value = "bca", MO, lOT, rOT)  
  
  grad_expr_stats = grad_expr_stats %>%
  gather(key = "ROI", value = "bca", MO, lOT, rOT)  
  
# Save in Rdata format
  save(grad_base_stats, file = "./data/grad_base_stats.RData")
  save(grad_expr_stats, file = "./data/grad_expr_stats.RData")   
                        

## Add self / parental report measures
   grad$SRS = qn_data$SRS_T2[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$GEM_T2 = qn_data$GEM_Total_T2[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$EMK_EM_P_T2 = qn_data$EMK_EM_P_T2[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$EMK_EM_CH_T2 = qn_data$EMK_EM_CH_T2[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$EMK_EK_P_T2 = qn_data$EMK_EK_P_T2[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$EMK_EK_CH_T2 = qn_data$EMK_EK_CH_T2[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$EMK_PB_CH_T2 = qn_data$EMK_PB_CH_T2[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$SDQ_PB_T2 = qn_data$SDQ_PB_T2[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$SDQ_T2 = qn_data$SDQ_Total_T2[match(grad$ID,qn_data$ID,nomatch = NA)]
 
   grad$d_GEM_Total = qn_data$d_GEM_Total[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$d_EMK_EM_CH = qn_data$d_EMK_EM_CH[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$d_EMK_EM_P = qn_data$d_EMK_EM_P[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$d_EMK_EK_CH = qn_data$d_EMK_EK_CH[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$d_EMK_EK_P = qn_data$d_EMK_EK_P[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$d_EMK_PB_CH = qn_data$d_EMK_PB_CH[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$d_SDQ_PB = qn_data$d_SDQ_PB[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$d_SDQ_Total = qn_data$d_SDQ_Total[match(grad$ID,qn_data$ID,nomatch = NA)]
   
```

# Grad-face data frequency pdi

```{r grad_data_pdi}

# Load qn_data
  load.Rdata(filename="./data/qn_data.RData", "qn_data")

# Exclude (EEG_Grad = 0) participants with no eligible FPVS grad-face data
  qn_data_grad = subset(qn_data, EEG_Grad == 1)

# Get baseline-corrected amplitude (bca) data

  # Base rate  
    base_hap_twent = read.delim("./data/grad_pdi_base_hap_twent.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    base_hap_fort = read.delim("./data/grad_pdi_base_hap_fort.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    base_hap_sixt = read.delim("./data/grad_pdi_base_hap_sixt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    base_hap_eigt = read.delim("./data/grad_pdi_base_hap_eigt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    base_hap_oneh = read.delim("./data/grad_pdi_base_hap_oneh.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    
    base_ang_twent = read.delim("./data/grad_pdi_base_ang_twent.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    base_ang_fort = read.delim("./data/grad_pdi_base_ang_fort.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    base_ang_sixt = read.delim("./data/grad_pdi_base_ang_sixt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    base_ang_eigt = read.delim("./data/grad_pdi_base_ang_eigt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    base_ang_oneh = read.delim("./data/grad_pdi_base_ang_oneh.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    
  # Expression change 
    expr_hap_twent = read.delim("./data/grad_pdi_expr_hap_twent.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    expr_hap_fort = read.delim("./data/grad_pdi_expr_hap_fort.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    expr_hap_sixt = read.delim("./data/grad_pdi_expr_hap_sixt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    expr_hap_eigt = read.delim("./data/grad_pdi_expr_hap_eigt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    expr_hap_oneh = read.delim("./data/grad_pdi_expr_hap_oneh.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    
    expr_ang_twent = read.delim("./data/grad_pdi_expr_ang_twent.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    expr_ang_fort = read.delim("./data/grad_pdi_expr_ang_fort.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    expr_ang_sixt = read.delim("./data/grad_pdi_expr_ang_sixt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    expr_ang_eigt = read.delim("./data/grad_pdi_expr_ang_eigt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    expr_ang_oneh = read.delim("./data/grad_pdi_expr_ang_oneh.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
    
# Add intensity 
  # Base rate 
  base_hap_twent = mutate(base_hap_twent, ID = qn_data_grad$ID, emotion = "happy", intens = "20%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   
   base_hap_fort = mutate(base_hap_fort, ID = qn_data_grad$ID, emotion = "happy", intens = "40%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   base_hap_sixt = mutate(base_hap_sixt, ID = qn_data_grad$ID, emotion = "happy", intens = "60%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   base_hap_eigt = mutate(base_hap_eigt, ID = qn_data_grad$ID, emotion = "happy", intens = "80%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   base_hap_oneh = mutate(base_hap_oneh, ID = qn_data_grad$ID, emotion = "happy", intens = "100%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)  
    
    
   base_ang_twent = mutate(base_ang_twent, ID = qn_data_grad$ID, emotion = "angry", intens = "20%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   
   base_ang_fort = mutate(base_ang_fort, ID = qn_data_grad$ID, emotion = "angry", intens = "40%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   base_ang_sixt = mutate(base_ang_sixt, ID = qn_data_grad$ID, emotion = "angry", intens = "60%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   base_ang_eigt = mutate(base_ang_eigt, ID = qn_data_grad$ID, emotion = "angry", intens = "80%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   base_ang_oneh = mutate(base_ang_oneh, ID = qn_data_grad$ID, emotion = "angry", intens = "100%", manip = "base",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
    
  # Expression change 
  expr_hap_twent = mutate(expr_hap_twent, ID = qn_data_grad$ID, emotion = "happy", intens = "20%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   
   expr_hap_fort = mutate(expr_hap_fort, ID = qn_data_grad$ID, emotion = "happy", intens = "40%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   expr_hap_sixt = mutate(expr_hap_sixt, ID = qn_data_grad$ID, emotion = "happy", intens = "60%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   expr_hap_eigt = mutate(expr_hap_eigt, ID = qn_data_grad$ID, emotion = "happy", intens = "80%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   expr_hap_oneh = mutate(expr_hap_oneh, ID = qn_data_grad$ID, emotion = "happy", intens = "100%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)  
    
    
   expr_ang_twent = mutate(expr_ang_twent, ID = qn_data_grad$ID, emotion = "angry", intens = "20%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   
   expr_ang_fort = mutate(expr_ang_fort, ID = qn_data_grad$ID, emotion = "angry", intens = "40%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   expr_ang_sixt = mutate(expr_ang_sixt, ID = qn_data_grad$ID, emotion = "angry", intens = "60%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   expr_ang_eigt = mutate(expr_ang_eigt, ID = qn_data_grad$ID, emotion = "angry", intens = "80%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
   expr_ang_oneh = mutate(expr_ang_oneh, ID = qn_data_grad$ID, emotion = "angry", intens = "100%", manip = "expr",
                                  age = qn_data_grad$age,
                                  sex = qn_data_grad$sex,
                                  group = qn_data_grad$group)
   
# Merge data frames together
  grad = bind_rows(
    base_hap_twent,base_hap_fort,base_hap_sixt, base_hap_eigt, base_hap_oneh,
    base_ang_twent,base_ang_fort,base_ang_sixt, base_ang_eigt, base_ang_oneh,
    expr_hap_twent,expr_hap_fort,expr_hap_sixt, expr_hap_eigt, expr_hap_oneh,
    expr_ang_twent,expr_ang_fort,expr_ang_sixt, expr_ang_eigt, expr_ang_oneh)
  
# Re-order data frame
  grad = subset(grad, select=c(ID, age, sex, group, emotion, manip, intens, Fp1:Oz))
 
# Re-factor variables of interest   
   grad$intens = factor(grad$intens, levels = c("20%", "40%", "60%","80%","100%"))
   grad$emotion = factor(grad$emotion, levels = c("happy","angry"))

   
# Select only channels of interest
  grad_ROI = subset(grad, select=c(ID, age, sex, group, emotion, intens, manip, O1, O2, Oz, PO3,
                                  PO7, P7, PO9, PO4, PO8, P8, PO10))
# Select base condition
  grad_base = subset(grad_ROI, manip == "base")

# Average base response for selected ROIs
  grad_base = dplyr::mutate(grad_base,
                        MO = rowMeans(grad_base[,c("O1", "O2", "Oz")], na.rm=TRUE),
                        lOT = rowMeans(grad_base[,c("P7", "PO7", "PO9", "PO3")], na.rm=TRUE),
                        rOT = rowMeans(grad_base[,c("P8", "PO8", "PO10", "PO4")], na.rm=TRUE))

# Select expression change condition
  grad_expr = subset(grad_ROI, manip == "expr")

# Average expression change response for selected ROIs
  grad_expr = dplyr::mutate(grad_expr,
                         MO = rowMeans(grad_expr[,c("O1", "O2", "Oz")], na.rm=TRUE),
                         lOT = rowMeans(grad_expr[,c("P7", "PO7", "PO9", "PO3")], na.rm=TRUE),
                         rOT = rowMeans(grad_expr[,c("P8", "PO8", "PO10", "PO4")], na.rm=TRUE))

## For bar plots 
  
# Select ROIs
  grad_expr_plot = subset(grad_expr, select=c(ID, emotion, intens, group, MO, lOT, rOT))
  grad_base_plot = subset(grad_base, select=c(ID, emotion, intens, group, MO, lOT, rOT))

# Transform from wide to long format
  grad_expr_plot = gather(grad_expr_plot, ROI, bca, MO:rOT, factor_key=TRUE)
  grad_base_plot = gather(grad_base_plot, ROI, bca, MO:rOT, factor_key=TRUE)
  
# Save in Rdata format
  save(grad_base_plot, file = "./data/grad_base_plot_pdi.RData")
  save(grad_expr_plot, file = "./data/grad_expr_plot_pdi.RData")  

## Topographies

# Select data
  grad_topo = subset(grad, select=c(ID, manip, emotion, group, intens, Fp1:Oz))

# Add time variable
  grad_topo = mutate(grad_topo, time = 1)

# Change from wide to long format for electrodes
  grad_topo = gather(grad_topo, electrode, amplitude, Fp1:Oz, factor_key=TRUE)  
  
# Save in Rdata format
  save(grad_topo, file = "./data/grad_topo.RData")
 
## For stats   
  
# Select ROIs
  grad_base_stats = subset(grad_base, select=c(ID, emotion, group, intens, MO, lOT, rOT))
  grad_expr_stats = subset(grad_expr, select=c(ID, emotion, group, intens, MO, lOT, rOT))

# Change format from wide to long
  grad_base_stats = grad_base_stats %>%
  gather(key = "ROI", value = "bca", MO, lOT, rOT)  
  
  grad_expr_stats = grad_expr_stats %>%
  gather(key = "ROI", value = "bca", MO, lOT, rOT)  
  
# Save in Rdata format
  save(grad_base_stats, file = "./data/grad_base_stats_pdi.RData")
  save(grad_expr_stats, file = "./data/grad_expr_stats_pdi.RData")   
                        

## Add self / parental report measures
   grad$SRS = qn_data$SRS_T2[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$GEM_T2 = qn_data$GEM_Total_T2[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$EMK_EM_P_T2 = qn_data$EMK_EM_P_T2[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$EMK_EM_CH_T2 = qn_data$EMK_EM_CH_T2[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$EMK_EK_P_T2 = qn_data$EMK_EK_P_T2[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$EMK_EK_CH_T2 = qn_data$EMK_EK_CH_T2[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$EMK_PB_CH_T2 = qn_data$EMK_PB_CH_T2[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$SDQ_PB_T2 = qn_data$SDQ_PB_T2[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$SDQ_T2 = qn_data$SDQ_Total_T2[match(grad$ID,qn_data$ID,nomatch = NA)]
 
   grad$d_GEM_Total = qn_data$d_GEM_Total[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$d_EMK_EM_CH = qn_data$d_EMK_EM_CH[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$d_EMK_EM_P = qn_data$d_EMK_EM_P[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$d_EMK_EK_CH = qn_data$d_EMK_EK_CH[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$d_EMK_EK_P = qn_data$d_EMK_EK_P[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$d_EMK_PB_CH = qn_data$d_EMK_PB_CH[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$d_SDQ_PB = qn_data$d_SDQ_PB[match(grad$ID,qn_data$ID,nomatch = NA)]
   grad$d_SDQ_Total = qn_data$d_SDQ_Total[match(grad$ID,qn_data$ID,nomatch = NA)]
   
```

# Grad-face data time domain 

```{r grad_data_time}

# Load data
  grad_P1_amp_twent = read.delim("./data/grad_P1_twent_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_P1_amp_fort = read.delim("./data/grad_P1_fort_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_P1_amp_sixt = read.delim("./data/grad_P1_sixt_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_P1_amp_eigt = read.delim("./data/grad_P1_eigt_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_P1_amp_oneh = read.delim("./data/grad_P1_oneh_singl_trials.txt", header = TRUE, sep = " ", dec = ".")

  grad_P1_amp_twent = read.delim("./data/grad_P1_twent_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_P1_amp_fort = read.delim("./data/grad_P1_fort_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_P1_amp_sixt = read.delim("./data/grad_P1_sixt_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_P1_amp_eigt = read.delim("./data/grad_P1_eigt_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_P1_amp_oneh = read.delim("./data/grad_P1_oneh_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  
  
# Add intensity
  grad_P1_amp_twent = mutate(grad_P1_amp_twent, intens = "20%")
  grad_P1_amp_fort = mutate(grad_P1_amp_fort, intens = "40%")
  grad_P1_amp_sixt = mutate(grad_P1_amp_sixt, intens = "60%")
  grad_P1_amp_eigt = mutate(grad_P1_amp_eigt, intens = "80%")
  grad_P1_amp_oneh = mutate(grad_P1_amp_oneh, intens = "100%")
    
# Combine datasets
  grad_P1 = rbind(grad_P1_amp_twent,grad_P1_amp_fort,grad_P1_amp_sixt,grad_P1_amp_eigt,grad_P1_amp_oneh)
  
# Recode emotion condition  
  grad_P1 =  grad_P1 %>% dplyr::mutate(emotion=dplyr::recode(emotion, 
                         `1`="happy",
                         `2`="angry"))
  
# Recode ROI condition
  
# Transform from wide to long format 
  grad_P1 = gather(grad_P1, elec, amp, O1:PO10, factor_key=TRUE)
  
  grad_P1$ROI = NA
  grad_P1[grad_P1$elec == "PO7" | grad_P1$elec == "PO3" | grad_P1$elec == "P7" | grad_P1$elec == "PO9",]$ROI = "lOT"
  grad_P1[grad_P1$elec == "PO8" | grad_P1$elec == "PO4" | grad_P1$elec == "P8" | grad_P1$elec == "PO10",]$ROI = "rOT"
  grad_P1[grad_P1$elec == "O1" | grad_P1$elec == "Oz" | grad_P1$elec == "O2",]$ROI = "MO"
  
# Add group
  grad_P1$group = qn_data_grad$group[match(grad_P1$ID,qn_data_grad$ID,nomatch = NA)]
  
# Save data
  save(grad_P1, file = "./data/grad_P1.RData") 
  
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  
# Load data
  grad_N170_amp_twent = read.delim("./data/grad_N170_twent_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_N170_amp_fort = read.delim("./data/grad_N170_fort_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_N170_amp_sixt = read.delim("./data/grad_N170_sixt_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_N170_amp_eigt = read.delim("./data/grad_N170_eigt_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_N170_amp_oneh = read.delim("./data/grad_N170_oneh_singl_trials.txt", header = TRUE, sep = " ", dec = ".")

  grad_N170_amp_twent = read.delim("./data/grad_N170_twent_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_N170_amp_fort = read.delim("./data/grad_N170_fort_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_N170_amp_sixt = read.delim("./data/grad_N170_sixt_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_N170_amp_eigt = read.delim("./data/grad_N170_eigt_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_N170_amp_oneh = read.delim("./data/grad_N170_oneh_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  
# Add intensity
  grad_N170_amp_twent = mutate(grad_N170_amp_twent, intens = "20%")
  grad_N170_amp_fort = mutate(grad_N170_amp_fort, intens = "40%")
  grad_N170_amp_sixt = mutate(grad_N170_amp_sixt, intens = "60%")
  grad_N170_amp_eigt = mutate(grad_N170_amp_eigt, intens = "80%")
  grad_N170_amp_oneh = mutate(grad_N170_amp_oneh, intens = "100%")
    
# Combine datasets
  grad_N170 = rbind(grad_N170_amp_twent,grad_N170_amp_fort,grad_N170_amp_sixt,grad_N170_amp_eigt,grad_N170_amp_oneh)
  
# Recode emotion condition  
  grad_N170 =  grad_N170 %>% dplyr::mutate(emotion=dplyr::recode(emotion, 
                         `1`="happy",
                         `2`="angry"))
  
# Recode ROI condition
  
# Transform from wide to long format 
  grad_N170 = gather(grad_N170, elec, amp, O1:PO10, factor_key=TRUE)
  
  grad_N170$ROI = NA
  grad_N170[grad_N170$elec == "PO7" | grad_N170$elec == "PO3" | grad_N170$elec == "P7" | grad_N170$elec == "PO9",]$ROI = "lOT"
  grad_N170[grad_N170$elec == "PO8" | grad_N170$elec == "PO4" | grad_N170$elec == "P8" | grad_N170$elec == "PO10",]$ROI = "rOT"
  grad_N170[grad_N170$elec == "O1" | grad_N170$elec == "Oz" | grad_N170$elec == "O2",]$ROI = "MO"
  
# Add group
  grad_N170$group = qn_data_grad$group[match(grad_N170$ID,qn_data_grad$ID,nomatch = NA)]
  
# Save data
  save(grad_N170, file = "./data/grad_N170.RData")   
  
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  
# Load data
  grad_P3_amp_twent = read.delim("./data/grad_P3_twent_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_P3_amp_fort = read.delim("./data/grad_P3_fort_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_P3_amp_sixt = read.delim("./data/grad_P3_sixt_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_P3_amp_eigt = read.delim("./data/grad_P3_eigt_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_P3_amp_oneh = read.delim("./data/grad_P3_oneh_singl_trials.txt", header = TRUE, sep = " ", dec = ".")

  grad_P3_amp_twent = read.delim("./data/grad_P3_twent_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_P3_amp_fort = read.delim("./data/grad_P3_fort_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_P3_amp_sixt = read.delim("./data/grad_P3_sixt_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_P3_amp_eigt = read.delim("./data/grad_P3_eigt_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  grad_P3_amp_oneh = read.delim("./data/grad_P3_oneh_singl_trials.txt", header = TRUE, sep = " ", dec = ".")
  
  
# Add intensity
  grad_P3_amp_twent = mutate(grad_P3_amp_twent, intens = "20%")
  grad_P3_amp_fort = mutate(grad_P3_amp_fort, intens = "40%")
  grad_P3_amp_sixt = mutate(grad_P3_amp_sixt, intens = "60%")
  grad_P3_amp_eigt = mutate(grad_P3_amp_eigt, intens = "80%")
  grad_P3_amp_oneh = mutate(grad_P3_amp_oneh, intens = "100%")
    
# Combine datasets
  grad_P3 = rbind(grad_P3_amp_twent,grad_P3_amp_fort,grad_P3_amp_sixt,grad_P3_amp_eigt,grad_P3_amp_oneh)
  
# Recode emotion condition  
  grad_P3 =  grad_P3 %>% dplyr::mutate(emotion=dplyr::recode(emotion, 
                         `1`="happy",
                         `2`="angry"))
  
# Recode ROI condition
  
# Transform from wide to long format 
  grad_P3 = gather(grad_P3, elec, amp, O1:PO10, factor_key=TRUE)
  
  grad_P3$ROI = NA
  grad_P3[grad_P3$elec == "PO7" | grad_P3$elec == "PO3" | grad_P3$elec == "P7" | grad_P3$elec == "PO9",]$ROI = "lOT"
  grad_P3[grad_P3$elec == "PO8" | grad_P3$elec == "PO4" | grad_P3$elec == "P8" | grad_P3$elec == "PO10",]$ROI = "rOT"
  grad_P3[grad_P3$elec == "O1" | grad_P3$elec == "Oz" | grad_P3$elec == "O2",]$ROI = "MO"  
  
# Add group
  grad_P3$group = qn_data_grad$group[match(grad_P3$ID,qn_data_grad$ID,nomatch = NA)]
  
# Save data
  save(grad_P3, file = "./data/grad_P3.RData")  
  
```


# Grad-face individual z-scores

```{r grad_indiv_zscores_expr_change}

# Load qn_data
  load.Rdata(filename="./data/qn_data.RData", "qn_data")

# Exclude (EEG_Grad = 0) participants with no eligible FPVS grad-face data
  qn_data_grad = subset(qn_data, EEG_Grad == 1)

# Get z-scores for each channel with highest BCA for each individual 
  indiv_twent = read.delim("./data/grad_zscore_indiv_twent.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
  indiv_fort = read.delim("./data/grad_zscore_indiv_fort.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
  indiv_sixt = read.delim("./data/grad_zscore_indiv_sixt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
  indiv_eigt = read.delim("./data/grad_zscore_indiv_eigt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
  indiv_oneh = read.delim("./data/grad_zscore_indiv_oneh.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
  
# Replace ID
  indiv_twent$ID = qn_data_grad$ID
  indiv_fort$ID = qn_data_grad$ID
  indiv_sixt$ID = qn_data_grad$ID
  indiv_eigt$ID = qn_data_grad$ID
  indiv_oneh$ID = qn_data_grad$ID
  
# Match group
  indiv_twent$group = qn_data$group[match(indiv_twent$ID,qn_data$ID,nomatch = NA)]
  indiv_fort$group = qn_data$group[match(indiv_fort$ID,qn_data$ID,nomatch = NA)]
  indiv_sixt$group = qn_data$group[match(indiv_sixt$ID,qn_data$ID,nomatch = NA)]
  indiv_eigt$group = qn_data$group[match(indiv_eigt$ID,qn_data$ID,nomatch = NA)]
  indiv_oneh$group = qn_data$group[match(indiv_oneh$ID,qn_data$ID,nomatch = NA)]
  
# Add intensity  
  indiv_twent$intens = "20%"
  indiv_fort$intens = "40%"
  indiv_sixt$intens = "60%"
  indiv_eigt$intens = "80%"
  indiv_oneh$intens = "100%"
  
# Merge dataframe
  indiv_zscores = bind_rows(indiv_twent,indiv_fort,indiv_sixt,indiv_eigt, indiv_oneh)
  
# Recode channel numbers into channel names
  indiv_zscores$channel[indiv_zscores$channel == 40] = "O1"
  indiv_zscores$channel[indiv_zscores$channel == 41] = "O2"
  indiv_zscores$channel[indiv_zscores$channel == 42] = "Oz"
  indiv_zscores$channel[indiv_zscores$channel == 36] = "PO3"
  indiv_zscores$channel[indiv_zscores$channel == 38] = "PO7"
  indiv_zscores$channel[indiv_zscores$channel == 32] = "P7"
  indiv_zscores$channel[indiv_zscores$channel == 34] = "PO9"
  indiv_zscores$channel[indiv_zscores$channel == 37] = "PO4"
  indiv_zscores$channel[indiv_zscores$channel == 39] = "PO8"
  indiv_zscores$channel[indiv_zscores$channel == 33] = "P8"
  indiv_zscores$channel[indiv_zscores$channel == 35] = "PO10"
  
# Create factors
  indiv_zscores$intens = factor(indiv_zscores$intens, levels = c("20%","40%","60%","80%","100%"))
  indiv_zscores$ID = factor(indiv_zscores$ID)

# Select group
  indiv_ZE_zscores = subset(indiv_zscores, group == "ZE")
  
# Create table with z-Scores
  indiv_scores_ZE = as.data.frame(indiv_ZE_zscores$Z_score[indiv_ZE_zscores$intens == "20%"])
  indiv_scores_ZE$fort  = indiv_ZE_zscores$Z_score[indiv_ZE_zscores$intens == "40%"]
  indiv_scores_ZE$sixt  = indiv_ZE_zscores$Z_score[indiv_ZE_zscores$intens == "60%"]
  indiv_scores_ZE$eigt  = indiv_ZE_zscores$Z_score[indiv_ZE_zscores$intens == "80%"]
  indiv_scores_ZE$oneh  = indiv_ZE_zscores$Z_score[indiv_ZE_zscores$intens == "100%"]
  names(indiv_scores_ZE)[1] = c("twent")
  
# Save table
  write.table(indiv_scores_ZE,"./tables/indiv_zscores_ZE.txt",sep="\t",row.names=FALSE)
  
# Create table with channel names
  indiv_chans_ZE = as.data.frame(indiv_ZE_zscores$channel[indiv_ZE_zscores$intens == "20%"])
  indiv_chans_ZE$fort  = indiv_ZE_zscores$channel[indiv_ZE_zscores$intens == "40%"]
  indiv_chans_ZE$sixt  = indiv_ZE_zscores$channel[indiv_ZE_zscores$intens == "60%"]
  indiv_chans_ZE$eigt  = indiv_ZE_zscores$channel[indiv_ZE_zscores$intens == "80%"]
  indiv_chans_ZE$oneh  = indiv_ZE_zscores$channel[indiv_ZE_zscores$intens == "100%"]
  names(indiv_chans_ZE)[1] = c("twent")
  
# Save table
  write.table(indiv_chans_ZE,"./tables/indiv_chans_ZE.txt",sep="\t",row.names=FALSE)
  
# Prep for plotting
  chan_count_ZE_twent = indiv_chans_ZE %>%
    dplyr::count(twent)
  
  chan_count_ZE_twent$intens = "20%"
  names(chan_count_ZE_twent)[1] = c("channel")
  
  chan_count_ZE_fort = indiv_chans_ZE %>%
    dplyr::count(fort)
  
  chan_count_ZE_fort$intens = "40%"
  names(chan_count_ZE_fort)[1] = c("channel")
    
  chan_count_ZE_sixt = indiv_chans_ZE %>%
    dplyr::count(sixt)
  
  chan_count_ZE_sixt$intens = "60%"
  names(chan_count_ZE_sixt)[1] = c("channel")
  
  chan_count_ZE_eigt = indiv_chans_ZE %>%
    dplyr::count(eigt)
  
  
  chan_count_ZE_eigt$intens = "80%"
  names(chan_count_ZE_eigt)[1] = c("channel")
  
  chan_count_ZE_oneh = indiv_chans_ZE %>%
    dplyr::count(oneh)
  
  chan_count_ZE_oneh$intens = "100%"
  names(chan_count_ZE_oneh)[1] = c("channel")
  
  
  
# Merge dataframe
  indiv_chan_nam_ZE = bind_rows(chan_count_ZE_twent,chan_count_ZE_fort,
                            chan_count_ZE_sixt,chan_count_ZE_eigt, chan_count_ZE_oneh)
  
  ZE_chan_names = ggplot(indiv_chan_nam_ZE, aes(factor(channel), factor(intens,levels = c("20%","40%","60%","80%","100%")))) + 
  geom_dotplot(binaxis = "y", stackdir = "center", binpositions="all") + 
  geom_point(aes(size=n))+
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major = element_blank(), # get rid of major grid
    panel.grid.minor = element_blank(), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent")) # get rid of legend panel bg)
  
  ZE_chan_names
  
  ggsave("./figures/ZE_chan_names.png", bg = "transparent", dpi = 300) 

# Select group
  indiv_CT_zscores = subset(indiv_zscores, group == "CT")  
  
# Create table with z-Scores
  indiv_scores_CT = as.data.frame(indiv_CT_zscores$Z_score[indiv_CT_zscores$intens == "20%"])
  indiv_scores_CT$fort  = indiv_CT_zscores$Z_score[indiv_CT_zscores$intens == "40%"]
  indiv_scores_CT$sixt  = indiv_CT_zscores$Z_score[indiv_CT_zscores$intens == "60%"]
  indiv_scores_CT$eigt  = indiv_CT_zscores$Z_score[indiv_CT_zscores$intens == "80%"]
  indiv_scores_CT$oneh  = indiv_CT_zscores$Z_score[indiv_CT_zscores$intens == "100%"]
  names(indiv_scores_CT)[1] = c("twent")
  
# Save table
  write.table(indiv_scores_CT,"./tables/indiv_zscores_CT.txt",sep="\t",row.names=FALSE)
  
# Create table with channel names
  indiv_chans_CT = as.data.frame(indiv_CT_zscores$channel[indiv_CT_zscores$intens == "20%"])
  indiv_chans_CT$fort  = indiv_CT_zscores$channel[indiv_CT_zscores$intens == "40%"]
  indiv_chans_CT$sixt  = indiv_CT_zscores$channel[indiv_CT_zscores$intens == "60%"]
  indiv_chans_CT$eigt  = indiv_CT_zscores$channel[indiv_CT_zscores$intens == "80%"]
  indiv_chans_CT$oneh  = indiv_CT_zscores$channel[indiv_CT_zscores$intens == "100%"]
  names(indiv_chans_CT)[1] = c("twent")
  
# Save table
  write.table(indiv_chans_CT,"./tables/indiv_chans_CT.txt",sep="\t",row.names=FALSE)
  
# Prep for plotting
  chan_count_CT_twent = indiv_chans_CT %>%
    dplyr::count(twent)
  
  chan_count_CT_twent$intens = "20%"
  names(chan_count_CT_twent)[1] = c("channel")
  
  chan_count_CT_fort = indiv_chans_CT %>%
    dplyr::count(fort)
  
  chan_count_CT_fort$intens = "40%"
  names(chan_count_CT_fort)[1] = c("channel")
    
  chan_count_CT_sixt = indiv_chans_CT %>%
    dplyr::count(sixt)
  
  chan_count_CT_sixt$intens = "60%"
  names(chan_count_CT_sixt)[1] = c("channel")
  
  chan_count_CT_eigt = indiv_chans_CT %>%
    dplyr::count(eigt)
  
  
  chan_count_CT_eigt$intens = "80%"
  names(chan_count_CT_eigt)[1] = c("channel")
  
  chan_count_CT_oneh = indiv_chans_CT %>%
    dplyr::count(oneh)
  
  chan_count_CT_oneh$intens = "100%"
  names(chan_count_CT_oneh)[1] = c("channel")
  
  
# Merge dataframe
  indiv_chan_nam_CT = bind_rows(chan_count_CT_twent,chan_count_CT_fort,
                            chan_count_CT_sixt,chan_count_CT_eigt, chan_count_CT_oneh)
  
  CT_chan_names = ggplot(indiv_chan_nam_CT, aes(factor(channel), factor(intens,levels = c("20%","40%","60%","80%","100%")))) + 
  geom_dotplot(binaxis = "y", stackdir = "center", binpositions="all") + 
  geom_point(aes(size=n))+
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major = element_blank(), # get rid of major grid
    panel.grid.minor = element_blank(), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent")) # get rid of legend panel bg)
  
  CT_chan_names
  
  ggsave("./figures/CT_chan_names.png", bg = "transparent", dpi = 300) 
  

  indiv_chans_CT = as.data.frame(indiv_CT_zscores$channel[indiv_CT_zscores$intens == "20%"])
  indiv_chans_CT$fort  = indiv_CT_zscores$channel[indiv_CT_zscores$intens == "40%"]
  indiv_chans_CT$sixt  = indiv_CT_zscores$channel[indiv_CT_zscores$intens == "60%"]
  indiv_chans_CT$eigt  = indiv_CT_zscores$channel[indiv_CT_zscores$intens == "80%"]
  indiv_chans_CT$oneh  = indiv_CT_zscores$channel[indiv_CT_zscores$intens == "100%"]
  names(indiv_chans_CT)[1] = c("twent")
  
```

```{r grad_indiv_zscores_base_response}

# Load qn_data
  load.Rdata(filename="./data/qn_data.RData", "qn_data")

# Exclude (EEG_Grad = 0) participants with no eligible FPVS grad-face data
  qn_data_grad = subset(qn_data, EEG_Grad == 1)

# Get z-scores for each channel with highest BCA for each individual 
  indiv_twent = read.delim("./data/grad_zscore_base_indiv_twent.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
  indiv_fort = read.delim("./data/grad_zscore_base_indiv_fort.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
  indiv_sixt = read.delim("./data/grad_zscore_base_indiv_sixt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
  indiv_eigt = read.delim("./data/grad_zscore_base_indiv_eigt.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
  indiv_oneh = read.delim("./data/grad_zscore_base_indiv_oneh.txt", header = TRUE, sep = " ", dec = ".", stringsAsFactors=FALSE)
  
# Replace ID
  indiv_twent$ID = qn_data_grad$ID
  indiv_fort$ID = qn_data_grad$ID
  indiv_sixt$ID = qn_data_grad$ID
  indiv_eigt$ID = qn_data_grad$ID
  indiv_oneh$ID = qn_data_grad$ID
  
# Match group
  indiv_twent$group = qn_data$group[match(indiv_twent$ID,qn_data$ID,nomatch = NA)]
  indiv_fort$group = qn_data$group[match(indiv_fort$ID,qn_data$ID,nomatch = NA)]
  indiv_sixt$group = qn_data$group[match(indiv_sixt$ID,qn_data$ID,nomatch = NA)]
  indiv_eigt$group = qn_data$group[match(indiv_eigt$ID,qn_data$ID,nomatch = NA)]
  indiv_oneh$group = qn_data$group[match(indiv_oneh$ID,qn_data$ID,nomatch = NA)]
  
# Add intensity  
  indiv_twent$intens = "20%"
  indiv_fort$intens = "40%"
  indiv_sixt$intens = "60%"
  indiv_eigt$intens = "80%"
  indiv_oneh$intens = "100%"
  
# Merge dataframe
  indiv_zscores = bind_rows(indiv_twent,indiv_fort,indiv_sixt,indiv_eigt, indiv_oneh)
  
# Recode channel numbers into channel names
  indiv_zscores$channel[indiv_zscores$channel == 40] = "O1"
  indiv_zscores$channel[indiv_zscores$channel == 41] = "O2"
  indiv_zscores$channel[indiv_zscores$channel == 42] = "Oz"
  indiv_zscores$channel[indiv_zscores$channel == 36] = "PO3"
  indiv_zscores$channel[indiv_zscores$channel == 38] = "PO7"
  indiv_zscores$channel[indiv_zscores$channel == 32] = "P7"
  indiv_zscores$channel[indiv_zscores$channel == 34] = "PO9"
  indiv_zscores$channel[indiv_zscores$channel == 37] = "PO4"
  indiv_zscores$channel[indiv_zscores$channel == 39] = "PO8"
  indiv_zscores$channel[indiv_zscores$channel == 33] = "P8"
  indiv_zscores$channel[indiv_zscores$channel == 35] = "PO10"
  
# Create factors
  indiv_zscores$intens = factor(indiv_zscores$intens, levels = c("20%","40%","60%","80%","100%"))
  indiv_zscores$ID = factor(indiv_zscores$ID)

# Select group
  indiv_ZE_zscores = subset(indiv_zscores, group == "ZE")
  
# Create table with z-Scores
  indiv_scores_ZE = as.data.frame(indiv_ZE_zscores$Z_score[indiv_ZE_zscores$intens == "20%"])
  indiv_scores_ZE$fort  = indiv_ZE_zscores$Z_score[indiv_ZE_zscores$intens == "40%"]
  indiv_scores_ZE$sixt  = indiv_ZE_zscores$Z_score[indiv_ZE_zscores$intens == "60%"]
  indiv_scores_ZE$eigt  = indiv_ZE_zscores$Z_score[indiv_ZE_zscores$intens == "80%"]
  indiv_scores_ZE$oneh  = indiv_ZE_zscores$Z_score[indiv_ZE_zscores$intens == "100%"]
  names(indiv_scores_ZE)[1] = c("twent")
  
# Save table
  write.table(indiv_scores_ZE,"./tables/indiv_zscores_base_ZE.txt",sep="\t",row.names=FALSE)
  
# Create table with channel names
  indiv_chans_ZE = as.data.frame(indiv_ZE_zscores$channel[indiv_ZE_zscores$intens == "20%"])
  indiv_chans_ZE$fort  = indiv_ZE_zscores$channel[indiv_ZE_zscores$intens == "40%"]
  indiv_chans_ZE$sixt  = indiv_ZE_zscores$channel[indiv_ZE_zscores$intens == "60%"]
  indiv_chans_ZE$eigt  = indiv_ZE_zscores$channel[indiv_ZE_zscores$intens == "80%"]
  indiv_chans_ZE$oneh  = indiv_ZE_zscores$channel[indiv_ZE_zscores$intens == "100%"]
  names(indiv_chans_ZE)[1] = c("twent")
  
# Save table
  write.table(indiv_chans_ZE,"./tables/indiv_chans_base_ZE.txt",sep="\t",row.names=FALSE)
  
# Prep for plotting
  chan_count_ZE_twent = indiv_chans_ZE %>%
    dplyr::count(twent)
  
  chan_count_ZE_twent$intens = "20%"
  names(chan_count_ZE_twent)[1] = c("channel")
  
  chan_count_ZE_fort = indiv_chans_ZE %>%
    dplyr::count(fort)
  
  chan_count_ZE_fort$intens = "40%"
  names(chan_count_ZE_fort)[1] = c("channel")
    
  chan_count_ZE_sixt = indiv_chans_ZE %>%
    dplyr::count(sixt)
  
  chan_count_ZE_sixt$intens = "60%"
  names(chan_count_ZE_sixt)[1] = c("channel")
  
  chan_count_ZE_eigt = indiv_chans_ZE %>%
    dplyr::count(eigt)
  
  
  chan_count_ZE_eigt$intens = "80%"
  names(chan_count_ZE_eigt)[1] = c("channel")
  
  chan_count_ZE_oneh = indiv_chans_ZE %>%
    dplyr::count(oneh)
  
  chan_count_ZE_oneh$intens = "100%"
  names(chan_count_ZE_oneh)[1] = c("channel")
  
  
  
# Merge dataframe
  indiv_chan_nam_ZE = bind_rows(chan_count_ZE_twent,chan_count_ZE_fort,
                            chan_count_ZE_sixt,chan_count_ZE_eigt, chan_count_ZE_oneh)
  
  ZE_chan_names = ggplot(indiv_chan_nam_ZE, aes(factor(channel), factor(intens,levels = c("20%","40%","60%","80%","100%")))) + 
  geom_dotplot(binaxis = "y", stackdir = "center", binpositions="all") + 
  geom_point(aes(size=n))+
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major = element_blank(), # get rid of major grid
    panel.grid.minor = element_blank(), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent")) # get rid of legend panel bg)
  
  ZE_chan_names
  
  ggsave("./figures/ZE_chan_names_base.png", bg = "transparent", dpi = 300) 

# Select group
  indiv_CT_zscores = subset(indiv_zscores, group == "CT")  
  
# Create table with z-Scores
  indiv_scores_CT = as.data.frame(indiv_CT_zscores$Z_score[indiv_CT_zscores$intens == "20%"])
  indiv_scores_CT$fort  = indiv_CT_zscores$Z_score[indiv_CT_zscores$intens == "40%"]
  indiv_scores_CT$sixt  = indiv_CT_zscores$Z_score[indiv_CT_zscores$intens == "60%"]
  indiv_scores_CT$eigt  = indiv_CT_zscores$Z_score[indiv_CT_zscores$intens == "80%"]
  indiv_scores_CT$oneh  = indiv_CT_zscores$Z_score[indiv_CT_zscores$intens == "100%"]
  names(indiv_scores_CT)[1] = c("twent")
  
# Save table
  write.table(indiv_scores_CT,"./tables/indiv_zscores_base_CT.txt",sep="\t",row.names=FALSE)
  
# Create table with channel names
  indiv_chans_CT = as.data.frame(indiv_CT_zscores$channel[indiv_CT_zscores$intens == "20%"])
  indiv_chans_CT$fort  = indiv_CT_zscores$channel[indiv_CT_zscores$intens == "40%"]
  indiv_chans_CT$sixt  = indiv_CT_zscores$channel[indiv_CT_zscores$intens == "60%"]
  indiv_chans_CT$eigt  = indiv_CT_zscores$channel[indiv_CT_zscores$intens == "80%"]
  indiv_chans_CT$oneh  = indiv_CT_zscores$channel[indiv_CT_zscores$intens == "100%"]
  names(indiv_chans_CT)[1] = c("twent")
  
# Save table
  write.table(indiv_chans_CT,"./tables/indiv_chans_base_CT.txt",sep="\t",row.names=FALSE)
  
# Prep for plotting
  chan_count_CT_twent = indiv_chans_CT %>%
    dplyr::count(twent)
  
  chan_count_CT_twent$intens = "20%"
  names(chan_count_CT_twent)[1] = c("channel")
  
  chan_count_CT_fort = indiv_chans_CT %>%
    dplyr::count(fort)
  
  chan_count_CT_fort$intens = "40%"
  names(chan_count_CT_fort)[1] = c("channel")
    
  chan_count_CT_sixt = indiv_chans_CT %>%
    dplyr::count(sixt)
  
  chan_count_CT_sixt$intens = "60%"
  names(chan_count_CT_sixt)[1] = c("channel")
  
  chan_count_CT_eigt = indiv_chans_CT %>%
    dplyr::count(eigt)
  
  
  chan_count_CT_eigt$intens = "80%"
  names(chan_count_CT_eigt)[1] = c("channel")
  
  chan_count_CT_oneh = indiv_chans_CT %>%
    dplyr::count(oneh)
  
  chan_count_CT_oneh$intens = "100%"
  names(chan_count_CT_oneh)[1] = c("channel")
  
  
# Merge dataframe
  indiv_chan_nam_CT = bind_rows(chan_count_CT_twent,chan_count_CT_fort,
                            chan_count_CT_sixt,chan_count_CT_eigt, chan_count_CT_oneh)
  
  CT_chan_names = ggplot(indiv_chan_nam_CT, aes(factor(channel), factor(intens,levels = c("20%","40%","60%","80%","100%")))) + 
  geom_dotplot(binaxis = "y", stackdir = "center", binpositions="all") + 
  geom_point(aes(size=n))+
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major = element_blank(), # get rid of major grid
    panel.grid.minor = element_blank(), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent")) # get rid of legend panel bg)
  
  CT_chan_names
  
  ggsave("./figures/CT_chan_names_base.png", bg = "transparent", dpi = 300) 
  

  indiv_chans_CT = as.data.frame(indiv_CT_zscores$channel[indiv_CT_zscores$intens == "20%"])
  indiv_chans_CT$fort  = indiv_CT_zscores$channel[indiv_CT_zscores$intens == "40%"]
  indiv_chans_CT$sixt  = indiv_CT_zscores$channel[indiv_CT_zscores$intens == "60%"]
  indiv_chans_CT$eigt  = indiv_CT_zscores$channel[indiv_CT_zscores$intens == "80%"]
  indiv_chans_CT$oneh  = indiv_CT_zscores$channel[indiv_CT_zscores$intens == "100%"]
  names(indiv_chans_CT)[1] = c("twent")
  
```


# Session info

<!-- Provide session info  -->

```{r session_info, results = TRUE}

# Get session info 
  sessionInfo()

```

