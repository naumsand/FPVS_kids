---
title: "ERT"
output: 
  rmdformats::material:
    highlight: kate
    css: web_style.css
    thumbnails: false
    lightbox: true
    gallery: true
    cards: true
    self_contained: no
    number_sections: no
    code_folding: hide
    fig_caption: yes
---

```{r setup, include = FALSE, message = FALSE}

# Set general settings for Markdown file 
  options(max.print="75")

  knitr::opts_chunk$set(echo=TRUE,
  	             #cache=TRUE,
                 prompt=FALSE,
                 tidy=TRUE,
                 comment=NA,
                 message=FALSE,
                 warning=FALSE,
                 results = FALSE,
  	             fig.align="center")
  knitr::opts_knit$set(width=75)
  
# Load packages
  library(afex)
  library(car)
  library(corrplot)
  library(dplyr)
  library(eeptools)
  library(emmeans)
  library(ggplot2)
  library(kableExtra)
  library(lme4)
  library(lmerTest)
  library(pander)
  library(psycho)
  library(sjPlot) 
  library(XLConnect)
  
# Swipe environment
 rm(list=ls())  
 
# Define colors
 FPVS_col = c("#2e6456","#8ebcb0")
  
```

<br><br>

# Data selection

* Get mean accuracy per intensity condition

**Exclusion of participants:**

* Collect info from data collection sheet
  + Exclude: 19, 23, 39, 57 (pressed button randomly)
  
* Look at individual data
  + Questions: Does someone has very high / low RTs / Acc?
  + Not following linear increase (wrong button coding, fixed in script): 
  + happy: 1, 3, 8, 10, 11, 18, 20-22, 24, 25, 27-29, 36, 41, 42, 44, 45, 46, 48, 49-51, 54, 55, 58, 61, 62, 63, 65, 66, 69, 73, 74, 75, 76
* Very low accuracy:
  + happy: 44, 73
  + angry: 21
  
**Exclusion of values:**

* Reaction times too fast < 250 ms / too slow? > 3s (= NA values) (Johnston et al., 2011)
  
```{r prep_ERT_data_LMM, include = FALSE}

#### Get raw data 

# Get file names
  file_list = as_tibble(list.files(path = "./data/ERT/", pattern = "*.csv", all.files = FALSE))

# Create block info (60 trials per block; 2 blocks, 1 emotion per block (happy vs. angry))
  emo = rep(1:2, each=60)

# Run loop to merge all participants' data
  
  for (i in 1:nrow(file_list)) {
    
    if (i != 25) { # participants 26 EMT had to be aborted, hence exclusion
  
    # Load data
      part = as_tibble(read.csv(paste("./data/ERT/",file_list[i,1], sep = ""))) 
      # sep = no space between words
    
    # Define N/A data
      part[part=="NaN"] = NA
    
    # Add ID
      part$ID = substr(file_list[i,1],1,2)
      
    # Rename columns
      part = rename(part, stim = Image_1,
                            intens = emotion,
                            response = Answer,
                            RT = RT_in_ms)
      
    # Add emotion info
      part$emo = emo
      
    # Re-locate stimulus info to back of columns  
      part =
      part %>%
        relocate(stim, .after = RT) %>%
        relocate(ID) %>%
        relocate(emo, .after = ID) 
      
      
    # Transform seconds to mseconds
      part$RT = part$RT*1000
      
    # Exclude values < 250 ms
      part = subset(part, RT > 250)
      
    # Mark RT values with +/- 2.5 SD  
      part_RT_sd = sd(part$RT)
      part$SD_incl = 1
      part$SD_incl[part$RT > part_RT_sd*3.5 | part$RT < part_RT_sd/3.5] = 0
      
    # Combine datasets
      
      if (i == 1) {
        
        # Recode button order for block with happy faces
        part$response[part$emo == 2] = recode(part$response[part$emo == 2], `0` = 1, `1` = 0)
        ERT_data = part
        
      } else {
        
        # Re-code happy block (some participants had wrong button order)
          if (i == 1 | i == 3 | i == 7 | i == 9 | i == 10| i == 17 | 
              i == 19 | i == 20| i == 21 | i == 23 | i == 24| i == 26 |
              i == 27 | i == 28 | i == 35 | i == 40 | i == 41| i == 43 |
              i == 44 | i == 45 | i == 47 | i == 48| i == 49| 
              i == 50 | i == 53 | i == 54 | i == 57| i == 60| i == 61 | 
              i == 62 | i == 64| i == 65| i == 66 | i == 68| i == 69 | i == 70| i == 71
              ){

            part$response[part$emo == 2] = recode(part$response[part$emo == 2], `0` = 1, `1` = 0)

          }
    
        ERT_data = rbind(ERT_data, part)
      }
      
      remove(part)
  }
  }
  
# Re-code intensity levels / emo  
  ERT_data$emo[ERT_data$emo == 1] = "angry"
  ERT_data$emo[ERT_data$emo == 2] = "happy"

  ERT_data$intens[ERT_data$intens== "hap20"] = "20"
  ERT_data$intens[ERT_data$intens== "hap40"] = "40"
  ERT_data$intens[ERT_data$intens== "hap60"] = "60"
  ERT_data$intens[ERT_data$intens== "hap80"] = "80"
  ERT_data$intens[ERT_data$intens== "hap100"] = "100"
  
  ERT_data$intens[ERT_data$intens== "ang20"] = "20"
  ERT_data$intens[ERT_data$intens== "ang40"] = "40"
  ERT_data$intens[ERT_data$intens== "ang60"] = "60"
  ERT_data$intens[ERT_data$intens== "ang80"] = "80"
  ERT_data$intens[ERT_data$intens== "ang100"] = "100" 
  
# Factor intensity
  ERT_data$intens = factor(ERT_data$intens, levels = c("neu", "20", "40", "60", "80", "100"))
  
#### Add questionnaire data  
    
# Load questionnaire data
  qn_data = readWorksheetFromFile("./data/qn_data.xlsx",
                             sheet = 1,
                             startCol = 1,
                             endCol = 0)
  
# Add column to include participants (exclusion reason: non-compliance)
  qn_data$part_incl = 1
  qn_data$part_incl[qn_data$ID == 19 | qn_data$ID == 23 | qn_data$ID == 39 | qn_data$ID == 57] = 0
  

# Calculate overall accuracy (Eventually: Exclude participants < 50 % accuracy)
  ERT_acc =
  ERT_data %>%
  group_by(ID) %>% 
  summarise(n_hit = sum(response, na.rm = TRUE),
            perc_hit = (n_hit/120))  
  
  ERT_acc$acc_incl = 1
  ERT_acc$acc_incl[ERT_acc$perc_hit < .5] = 0
  
# Re-code gender
  qn_data$sex[qn_data$sex == 1] = "Male"
  qn_data$sex[qn_data$sex == 2] = "Female"
  
# Re-code training group
  qn_data$group[qn_data$group == "ZE"] = "TG"
  qn_data$group[qn_data$group == "SB"] = "CG"

# Define N/A data
  qn_data[qn_data==-99] = NA
  
# Calculate age (Extract age from birth/test date)
  qn_data$age = as.numeric(cbind(age_calc(as.Date(qn_data$birth_date),
                                     as.Date(qn_data$test_date), units = "years"))) 
  
# Calculate median for age
  med_age = median(qn_data$age)
  
  qn_data$med_age[qn_data$age < med_age] = 1
  qn_data$med_age[qn_data$age >= med_age] = 2

# Z-scoring for parental / self-report measures 
  qn_data$z_GEM_T2 = scale(qn_data$GEM_Total_T2)
  qn_data$z_EMK_EM_P_T2 = scale(qn_data$EMK_EM_P_T2)
  qn_data$z_EMK_EM_CH_T2 = scale(qn_data$EMK_EM_CH_T2)
  qn_data$z_EMK_EK_P_T2 = scale(qn_data$EMK_EK_P_T2)
  qn_data$z_EMK_EK_CH_T2 = scale(qn_data$EMK_EK_CH_T2)
  qn_data$z_EMK_PB_CH_T2 = scale(qn_data$EMK_PB_CH_T2)
  qn_data$z_SDQ_PB_T2 = scale(qn_data$SDQ_PB_T2)
  qn_data$z_SDQ_T2 = scale(qn_data$SDQ_Total_T2)  

# Calculate change scores (d = delta) for T2
  qn_data$d_GEM_Total = qn_data$GEM_Total_T2 - qn_data$GEM_Total_T1
  qn_data$d_EMK_EM_CH = qn_data$EMK_EM_CH_T2 - qn_data$EMK_EM_CH_T1
  qn_data$d_EMK_EM_P = qn_data$EMK_EM_P_T2 - qn_data$EMK_EM_P_T1
  qn_data$d_EMK_EK_CH = qn_data$EMK_EK_CH_T2 - qn_data$EMK_EK_CH_T1
  qn_data$d_EMK_EK_P = qn_data$EMK_EK_P_T2 - qn_data$EMK_EK_P_T1
  qn_data$d_EMK_PB_CH = qn_data$EMK_PB_CH_T2 - qn_data$EMK_PB_CH_T1
  qn_data$d_SDQ_PB = qn_data$SDQ_PB_T2 - qn_data$SDQ_PB_T1
  qn_data$d_SDQ_Total = qn_data$SDQ_Total_T1 - qn_data$SDQ_Total_T2
  
# Calculate z-scores of change scores (d = delta) for T2
  qn_data$zd_GEM_Total = scale(qn_data$d_GEM_Total) 
  qn_data$zd_EMK_EM_CH = scale(qn_data$d_EMK_EM_CH)
  qn_data$zd_EMK_EM_P = scale(qn_data$d_EMK_EM_P)
  qn_data$zd_EMK_EK_CH = scale(qn_data$d_EMK_EK_CH)
  qn_data$zd_EMK_EK_P = scale(qn_data$d_EMK_EK_P)
  qn_data$zd_EMK_PB_CH = scale(qn_data$d_EMK_PB_CH)
  qn_data$zd_SDQ_PB = scale(qn_data$d_SDQ_PB)
  qn_data$zd_SDQ_Total = scale(qn_data$d_SDQ_Total)

# Calculate EMK composite scores (empathy (parent / child) and emotion knowledge (parent/child)) using z-scores
  qn_data$zd_EMK_EM_comp = scale(qn_data$d_EMK_EM_CH) + scale(qn_data$d_EMK_EM_P)
  qn_data$zd_EMK_EK_comp = scale(qn_data$d_EMK_EK_CH) + scale(qn_data$d_EMK_EK_P) 
  
# Z-scoring for covariates 
  qn_data$z_age = scale(qn_data$age)
  qn_data$z_CPM = scale(qn_data$CPM)  
  
# Change QN_data ID format to ID format of EEG_behav_data
  IDs = c(paste("0",c(1:9), sep=""), paste(c(10:76), sep=""))  
  qn_data$ID = IDs    

# Match with parental / self-report measures 
  ERT_data$part_incl = qn_data$part_incl[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$acc_incl = ERT_acc$acc_incl[match(ERT_data$ID,ERT_acc$ID,nomatch = NA)]
  ERT_data$group = qn_data$group[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$sex = qn_data$sex[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  
  ERT_data$age = qn_data$age[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$CPM = qn_data$CPM[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$med_age = qn_data$med_age[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
    
  ERT_data$z_age = qn_data$z_age[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$z_CPM = qn_data$z_CPM[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  
  ERT_data$GEM_T2 = qn_data$GEM_Total_T2[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$EMK_EM_P_T2 = qn_data$EMK_EM_P_T2[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$EMK_EM_CH_T2 = qn_data$EMK_EM_CH_T2[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$EMK_EK_P_T2 = qn_data$EMK_EK_P_T2[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$EMK_EK_CH_T2 = qn_data$EMK_EK_CH_T2[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$EMK_PB_CH_T2 = qn_data$EMK_PB_CH_T2[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$SDQ_PB_T2 = qn_data$SDQ_PB_T2[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$SDQ_T2 = qn_data$SDQ_Total_T2[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  
  ERT_data$z_GEM_T2 = qn_data$z_GEM_T2[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$z_EMK_EM_P_T2 = qn_data$z_EMK_EM_P_T2[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$z_EMK_EM_CH_T2 = qn_data$z_EMK_EM_CH_T2[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$z_EMK_EK_P_T2 = qn_data$z_EMK_EK_P_T2[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$z_EMK_EK_CH_T2 = qn_data$z_EMK_EK_CH_T2[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$z_EMK_PB_CH_T2 = qn_data$z_EMK_PB_CH_T2[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$z_SDQ_PB_T2 = qn_data$z_SDQ_PB_T2[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$z_SDQ_T2 = qn_data$z_SDQ_T2[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  
  ERT_data$d_GEM_Total = qn_data$d_GEM_Total[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$d_EMK_EM_CH = qn_data$d_EMK_EM_CH[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$d_EMK_EM_P = qn_data$d_EMK_EM_P[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$d_EMK_EK_CH = qn_data$d_EMK_EK_CH[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$d_EMK_EK_P = qn_data$d_EMK_EK_P[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$d_EMK_PB_CH = qn_data$d_EMK_PB_CH[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$d_SDQ_PB = qn_data$d_SDQ_PB[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$d_SDQ_Total = qn_data$d_SDQ_Total[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  
  ERT_data$zd_GEM_Total = qn_data$zd_GEM_Total[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$zd_EMK_EM_CH = qn_data$zd_EMK_EM_CH[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$zd_EMK_EM_P = qn_data$zd_EMK_EM_P[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$zd_EMK_EK_CH = qn_data$zd_EMK_EK_CH[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$zd_EMK_EK_P = qn_data$zd_EMK_EK_P[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$zd_EMK_PB_CH = qn_data$zd_EMK_PB_CH[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$zd_SDQ_PB = qn_data$zd_SDQ_PB[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  ERT_data$zd_SDQ_Total = qn_data$zd_SDQ_Total[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  
  ERT_data$EEG_Max = qn_data$EEG_Max[match(ERT_data$ID,qn_data$ID,nomatch = NA)]
  
# Factor group levels
  ERT_data$group = factor(ERT_data$group)
  
  ERT_data = subset(ERT_data, EEG_Max == 1)  

```

```{r prep_ERT_data_ANOVA, include = FALSE}

#### With SDs

# Set number of trials per condition (120 total, 20 for neutral (10 per block), 10 per emotion intensity)
  ntrials = 10

# Calculate n_hit (response = 1) and n_fa (fals alarms, response = 0) n_miss ( response = NA) rates, RT
  ERT_means =
  ERT_data %>%
  group_by(ID, intens, emo) %>% 
  summarise(n_hit = sum(response, na.rm = TRUE),
            perc_hit = n_hit/ntrials,
            n_fa = sum(response == 0, na.rm = TRUE),
            perc_fa = n_fa/ntrials,
            n_miss = sum(is.na(response)),
            RT = mean(RT, na.rm = TRUE))
  
# Match with parental / self-report measures 
  ERT_means$part_incl = qn_data$part_incl[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$group = qn_data$group[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$sex = qn_data$sex[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  
  ERT_means$age = qn_data$age[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$med_age = qn_data$med_age[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$CPM = qn_data$CPM[match(ERT_means$ID,qn_data$ID,nomatch = NA)] 
  
  ERT_means$GEM_T2 = qn_data$GEM_Total_T2[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$EMK_EM_P_T2 = qn_data$EMK_EM_P_T2[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$EMK_EM_CH_T2 = qn_data$EMK_EM_CH_T2[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$EMK_EK_P_T2 = qn_data$EMK_EK_P_T2[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$EMK_EK_CH_T2 = qn_data$EMK_EK_CH_T2[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$EMK_PB_CH_T2 = qn_data$EMK_PB_CH_T2[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$SDQ_PB_T2 = qn_data$SDQ_PB_T2[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$SDQ_T2 = qn_data$SDQ_Total_T2[match(ERT_means$ID,qn_data$ID,nomatch = NA)]

  ERT_means$d_GEM_Total = qn_data$d_GEM_Total[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$d_EMK_EM_CH = qn_data$d_EMK_EM_CH[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$d_EMK_EM_P = qn_data$d_EMK_EM_P[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$d_EMK_EK_CH = qn_data$d_EMK_EK_CH[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$d_EMK_EK_P = qn_data$d_EMK_EK_P[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$d_EMK_PB_CH = qn_data$d_EMK_PB_CH[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$d_SDQ_PB = qn_data$d_SDQ_PB[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$d_SDQ_Total = qn_data$d_SDQ_Total[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  ERT_means$EEG_Max = qn_data$EEG_Max[match(ERT_means$ID,qn_data$ID,nomatch = NA)]
  
  
  ERT_means = subset(ERT_means, EEG_Max == 1)  
  
#### Without SDs  
  ERT_means_SD = subset(ERT_data, SD_incl == 1)
  
# Calculate n_hit (response = 1) and n_fa (fals alarms, response = 0) n_miss ( response = NA) rates, RT
  ERT_means_SD =
  ERT_means_SD %>%
  group_by(ID, intens, emo) %>% 
  summarise(n_hit = sum(response, na.rm = TRUE),
            perc_hit = (n_hit*ntrials)/100,
            n_fa = sum(response == 0, na.rm = TRUE),
            perc_fa = (n_fa*ntrials)/100,
            n_miss = sum(is.na(response)),
            RT = mean(RT, na.rm = TRUE))
  
# Match with parental / self-report measures
  ERT_means_SD$part_incl = qn_data$part_incl[match(ERT_means_SD$ID,qn_data$ID,nomatch = NA)]
  ERT_means_SD$group = qn_data$group[match(ERT_means_SD$ID,qn_data$ID,nomatch = NA)]
  ERT_means_SD$sex = qn_data$sex[match(ERT_means_SD$ID,qn_data$ID,nomatch = NA)]

  
  ERT_means_SD$age = qn_data$age[match(ERT_means_SD$ID,qn_data$ID,nomatch = NA)]
  ERT_means_SD$med_age = qn_data$med_age[match(ERT_means_SD$ID,qn_data$ID,nomatch = NA)]
  ERT_means_SD$CPM = qn_data$CPM[match(ERT_means_SD$ID,qn_data$ID,nomatch = NA)]   

```

```{r excl_part, include = FALSE}

  ERT_data = subset (ERT_data, part_incl == 1)
  ERT_means = subset (ERT_means, part_incl == 1)

```

# Visualization {.tabset .tabset-pills}

## Overall RT / Acc 

```{r first_vis_Acc, results = "asis", fig.width = 8, fig.height = 5}

ERT_means_emo = subset (ERT_means, intens != "neu")

# Separate for angry vs. happy faces
  acc_plot = ggplot(ERT_means_emo, aes(x = intens, y = perc_hit, fill = group)) +
  stat_boxplot(geom ='errorbar', width=0.5, size=0.7, coef=1, position=position_dodge(0.65)) +
  geom_boxplot(coef=1, outlier.shape = NA, width=0.7, lwd=1, alpha=1, position=position_dodge(0.65)) +
  labs(x = "Intensity [%]", y = "Accuracy") +
  scale_fill_manual(values = FPVS_col) +
  theme_bw()+
  theme(panel.background = element_rect(fill = "transparent"),
  plot.background = element_rect(fill = "transparent", color = NA),
  legend.background = element_rect(fill = "transparent"), # get rid of legend bg
  legend.box.background = element_rect(fill = "transparent"))+
  facet_wrap(~emo)
  
acc_plot  
  
ggsave("./figures/acc_plot.png", bg = "transparent", dpi = 300)
  
  
```

```{r acc_ANOVA_group_intens_emo, results = "asis"}

# Exclude neutral condition for now 
  ERT_means_emo = subset(ERT_means, intens != "neu")

  ERT_anov =  aov_ez("ID", "perc_hit", ERT_means_emo , between = c("group"), within = c("intens", "emo"),
    #covariate = c("age", "sex"),
    #observed = c("age", "sex"), factorize = FALSE,
    anova_table = list(correction = "none", es = "pes"))
  
  pander(ERT_anov$anova_table)
  
# Do post-hoc tests
  ERT_acc_ph_1 = emmeans(ERT_anov, ~ "emo", by = "intens")
  kable(pairs(ERT_acc_ph_1))
  
# Do post-hoc test 
  ERT_acc_ph_2 = emmeans(ERT_anov, ~ "intens", by = "emo")
  kable(pairs(ERT_acc_ph_2))  

```

```{r first_vis_RT, results = "asis", fig.width = 8, fig.height = 5}

ERT_means_emo = subset (ERT_means, intens != "neu")

# Reaction times
  RT_plot = ggplot(ERT_means_emo, aes(x = intens, y = RT, fill = group)) +
  stat_boxplot(geom ='errorbar', width=0.5, size=0.7, coef=1, position=position_dodge(0.65)) +
  geom_boxplot(coef=1, outlier.shape = NA, width=0.7, lwd=1, alpha=1, position=position_dodge(0.65)) +
  labs(x = "Emotion intensity", y = "RT [ms]") +
  theme_bw()+
  theme(panel.background = element_rect(fill = "transparent"),
  plot.background = element_rect(fill = "transparent", color = NA),
  legend.background = element_rect(fill = "transparent"), # get rid of legend bg
  legend.box.background = element_rect(fill = "transparent"))+
  scale_fill_manual(values = FPVS_col) +
  facet_wrap(~emo)
  
RT_plot  
  
ggsave("./figures/RT_plot.png", bg = "transparent", dpi = 300)  
  
  
```

```{r RT_ANOVA_group_intens_emo, results = "asis"}

# Exclude neutral condition for now 
  ERT_means_emo = subset(ERT_means, intens != "neu")

  ERT_anov =  aov_ez("ID", "RT", ERT_means_emo , between = c("group"), within = c("intens", "emo"),
    #covariate = c("age", "sex"),
    #observed = c("age", "sex"), factorize = FALSE,
    anova_table = list(correction = "none", es = "pes"))
  
  pander(ERT_anov$anova_table)
  
# Do post-hoc tests
  ERT_RT_ph_1 = emmeans(ERT_anov, ~ "emo", by = "intens")
  kable(pairs(ERT_RT_ph_1))
  
# Do post-hoc test 
  ERT_RT_ph_2 = emmeans(ERT_anov, ~ "intens", by = "emo")
  kable(pairs(ERT_RT_ph_2))  
  
```


## Participants - Acc

```{r indiv_acc, results = "asis", fig.width = 8, fig.height = 30, eval = FALSE}

# Separate for angry vs. happy faces

  ERT_ang = subset(ERT_means, emo == "happy")

  ERT_ang_plot_indiv_acc = 
    ggplot(ERT_ang, aes(x = intens, y = perc_hit)) +
    stat_boxplot(geom ='errorbar', width=0.5, size=0.7, coef=1, position=position_dodge(0.65)) +
    geom_boxplot(coef=1, outlier.shape = NA, width=0.7, lwd=1, alpha=1, position=position_dodge(0.65)) +
    labs(x = "Emotion intensity", y = "Accuracy") +
    theme_bw()+
    facet_wrap(~ ID, ncol = 5)
  
  ERT_ang_plot_indiv_acc
    
  ERT_hap = subset(ERT_means, emo == "angry")

  ERT_hap_plot_indiv_acc = 
    ggplot(ERT_hap, aes(x = intens, y = perc_hit)) +
    stat_boxplot(geom ='errorbar', width=0.5, size=0.7, coef=1, position=position_dodge(0.65)) +
    geom_boxplot(coef=1, outlier.shape = NA, width=0.7, lwd=1, alpha=1, position=position_dodge(0.65)) +
    labs(x = "Emotion intensity", y = "Accuracy") +
    theme_bw() +
    facet_wrap(~ ID, ncol = 5)
  
  ERT_hap_plot_indiv_acc

```

## Participants - RT

```{r indiv_RT, results = "asis", fig.width = 8, fig.height = 30, eval = FALSE}

# Separate for angry vs. happy faces

  ERT_ang = subset(ERT_data, emo == "happy")

  ERT_ang_plot_indiv_RT = 
    ggplot(ERT_ang, aes(x = intens, y = RT)) +
    stat_boxplot(geom ='errorbar', width=0.5, size=0.7, coef=1, position=position_dodge(0.65)) +
    geom_boxplot(coef=1, outlier.shape = NA, width=0.7, lwd=1, alpha=1, position=position_dodge(0.65)) +
    labs(x = "Emotion intensity", y = "RT") +
    theme_bw()+
    facet_wrap(~ ID, ncol = 5)
  
  ERT_ang_plot_indiv_RT
    
  ERT_hap = subset(ERT_data, emo == "angry")

  ERT_hap_plot_indiv_RT = 
    ggplot(ERT_hap, aes(x = intens, y = RT)) +
    stat_boxplot(geom ='errorbar', width=0.5, size=0.7, coef=1, position=position_dodge(0.65)) +
    geom_boxplot(coef=1, outlier.shape = NA, width=0.7, lwd=1, alpha=1, position=position_dodge(0.65)) +
    labs(x = "Emotion intensity", y = "RT") +
    theme_bw() +
    facet_wrap(~ ID, ncol = 5)
  
  ERT_hap_plot_indiv_RT

```


## Age

```{r age_RT, results = "asis", fig.width = 8}

  ERT_age_RT = ggplot(ERT_means, aes(x = intens, y = RT, fill = group)) +
  stat_boxplot(geom ='errorbar', width=0.5, size=0.7, coef=1, position=position_dodge(0.65)) +
  geom_boxplot(coef=1, outlier.shape = NA, width=0.7, lwd=1, alpha=1, position=position_dodge(0.65)) +
  labs(x = "Emotion intensity", y = "RT [ms]") +
  theme_bw()+
  scale_fill_manual(values = FPVS_col) +
  facet_wrap(~ emo + med_age)

  ERT_age_RT

```

```{r age_acc, results = "asis", fig.width = 10}

ERT_age_acc = 
    ggplot(ERT_means, aes(x = intens, y = perc_hit, fill = group)) +
    stat_boxplot(geom ='errorbar', width=0.5, size=0.7, coef=1, position=position_dodge(0.65)) +
    geom_boxplot(coef=1, outlier.shape = NA, width=0.7, lwd=1, alpha=1, position=position_dodge(0.65)) +
    labs(x = "Emotion intensity", y = "Accuracy") +
    scale_fill_manual(values = FPVS_col) +
    theme_bw() +
    facet_wrap(~ emo + med_age)

ERT_age_acc

```


## Gender

```{r sex_RT, results = "asis", fig.width = 8}

  ERT_sex_RT = ggplot(ERT_means, aes(x = intens, y = RT, fill = group)) +
  stat_boxplot(geom ='errorbar', width=0.5, size=0.7, coef=1, position=position_dodge(0.65)) +
  geom_boxplot(coef=1, outlier.shape = NA, width=0.7, lwd=1, alpha=1, position=position_dodge(0.65)) +
  labs(x = "Emotion intensity", y = "RT [ms]") +
  theme_bw()+
  scale_fill_manual(values = FPVS_col) +
  facet_wrap(~ sex + emo)

  ERT_sex_RT

```

```{r sex_acc, results = "asis", fig.width = 10}

  ERT_sex_acc = 
    ggplot(ERT_means, aes(x = intens, y = perc_hit, fill = group)) +
    stat_boxplot(geom ='errorbar', width=0.5, size=0.7, coef=1, position=position_dodge(0.65)) +
    geom_boxplot(coef=1, outlier.shape = NA, width=0.7, lwd=1, alpha=1, position=position_dodge(0.65)) +
    labs(x = "Emotion intensity", y = "Accuracy") +
    scale_fill_manual(values = FPVS_col) +
    theme_bw() +
    facet_wrap(~ sex + emo)

  ERT_sex_acc

```



# Analysis {.tabset .tabset-pills}

## ANOVAs

```{r SD_ANOVA_group_intens_emo, eval = FALSE}

library(afex)
library(emmeans)
library(pander)

# Exclude neutral condition for now 
  ERT_means_emo = subset(ERT_means, intens != "neu")

  ERT_anov =  aov_ez("ID", "RT", ERT_means_emo , between = c("group"), within = c("intens", "emo"),
    #covariate = c("age", "sex"),
    #observed = c("age", "sex"), factorize = FALSE,
    anova_table = list(correction = "none", es = "pes"))
  
  pander(ERT_anov$anova_table)
  
# Do post-hoc test 
  ERT_ph = emmeans(ERT_anov, ~ "intens", by = "emo")
  ERT_ph_res = print(pairs(ERT_ph))
 
```

## LMMs

```{r RT_LMM_group_intens_emo,results = "asis"}

# Exclude neutral condition for now 
  ERT_LMM = subset(ERT_data, intens != "neu")
  ERT_LMM$intens = factor(ERT_LMM$intens, levels = c("20", "40", "60", "80", "100"))

# Factor variables
  ERT_LMM$emo = factor(ERT_LMM$emo)
  ERT_LMM$ID = factor(ERT_LMM$ID)
  ERT_LMM$stim = factor(ERT_LMM$stim)

# Create contrasts 
  contrasts(ERT_LMM$emo) = contr.treatment(2,  base = 1)
  contrasts(ERT_LMM$group) = contr.treatment(2,  base = 1)
  contrasts(ERT_LMM$intens) = contr.helmert(5)
  
## Check properties of DV / residuals 

# Visualize normality assumption of residuals (without log transform)
  mod_RT_lmm_no_log = lm(RT ~ group, data=ERT_LMM)
  res.mod_RT_lmm_no_log = residuals(mod_RT_lmm_no_log)

  par(mfrow=c(1,2))
  qqpl_RT_lmm_no_log = qqPlot(res.mod_RT_lmm_no_log, main="QQplot before transformation")    
  norm_RT_lmm_no_log = plot(density(res.mod_RT_lmm_no_log), main="Density plot before transformation")  
  par(mfrow=c(1,1))

# Build full model 
  mod_ERT_RT = lmer(RT ~ group + emo*intens +
                                   (1|ID) +
                                   (1|stim),
                                   data = ERT_LMM,
                                   control=lmerControl(calc.derivs = FALSE))  
  
# Print model
  tab_model(mod_ERT_RT)
  
```

## Correlation

```{r corr, results = "asis"}

# Potential options: split up for emotions only or training group 

# De-select variables
  ERT_cor_prep = subset(ERT_means, select = -c(sex, n_fa, n_hit, n_miss, part_incl, med_age))

# HAPPY

  ERT_cor_20_hap = subset(ERT_cor_prep, intens == "20" & emo == "happy")
  ERT_cor_20_hap = subset(ERT_cor_20_hap, select = -c(ID, group, intens, emo))
  
  ERT_cor_40_hap = subset(ERT_cor_prep, intens == "40" & emo == "happy")
  ERT_cor_40_hap = subset(ERT_cor_40_hap, select = -c(ID, group, intens, emo))
  
  ERT_cor_60_hap = subset(ERT_cor_prep, intens == "60" & emo == "happy")
  ERT_cor_60_hap = subset(ERT_cor_60_hap, select = -c(ID, group, intens, emo))
  
  ERT_cor_80_hap = subset(ERT_cor_prep, intens == "80" & emo == "happy")
  ERT_cor_80_hap = subset(ERT_cor_80_hap, select = -c(ID, group, intens, emo))
  
  ERT_cor_100_hap = subset(ERT_cor_prep, intens == "100" & emo == "happy")
  ERT_cor_100_hap = subset(ERT_cor_100_hap, select = -c(ID, group, intens, emo))

# Plot correlations - 20% happy
  corp_hap_20 = cor(ERT_cor_20_hap)
  corrplot(corp_hap_20, method = "circle", type = "lower", tl.col = "black")
  
# Plot correlations - 40% happy  
  corp_hap_40 = cor(ERT_cor_40_hap)
  corrplot(corp_hap_40, method = "circle", type = "lower", tl.col = "black")
  
# Plot correlations - 60% happy  
  corp_hap_60 = cor(ERT_cor_60_hap)
  corrplot(corp_hap_60, method = "circle", type = "lower", tl.col = "black")
  
# Plot correlations - 80% happy  
  corp_hap_80 = cor(ERT_cor_80_hap)
  corrplot(corp_hap_80, method = "circle", type = "lower", tl.col = "black")
  
# Plot correlations - 100% happy  
  corp_hap_100 = cor(ERT_cor_100_hap)
  corrplot(corp_hap_100, method = "circle", type = "lower", tl.col = "black") 
  
  
# ANGRY

  ERT_cor_20_ang = subset(ERT_cor_prep, intens == "20" & emo == "angry")
  ERT_cor_20_ang = subset(ERT_cor_20_ang, select = -c(ID, group, intens, emo))
  
  ERT_cor_40_ang = subset(ERT_cor_prep, intens == "40" & emo == "angry")
  ERT_cor_40_ang = subset(ERT_cor_40_ang, select = -c(ID, group, intens, emo))
  
  ERT_cor_60_ang = subset(ERT_cor_prep, intens == "60" & emo == "angry")
  ERT_cor_60_ang = subset(ERT_cor_60_ang, select = -c(ID, group, intens, emo))
  
  ERT_cor_80_ang = subset(ERT_cor_prep, intens == "80" & emo == "angry")
  ERT_cor_80_ang = subset(ERT_cor_80_ang, select = -c(ID, group, intens, emo))
  
  ERT_cor_100_ang = subset(ERT_cor_prep, intens == "100" & emo == "angry")
  ERT_cor_100_ang = subset(ERT_cor_100_ang, select = -c(ID, group, intens, emo))

# Plot correlations - 20% angry
  corp_ang_20 = cor(ERT_cor_20_ang)
  corrplot(corp_ang_20, method = "circle", type = "lower", tl.col = "black")
  
# Plot correlations - 40% angry  
  corp_ang_40 = cor(ERT_cor_40_ang)
  corrplot(corp_ang_40, method = "circle", type = "lower", tl.col = "black")
  
# Plot correlations - 60% angry  
  corp_ang_60 = cor(ERT_cor_60_ang)
  corrplot(corp_ang_60, method = "circle", type = "lower", tl.col = "black")
  
# Plot correlations - 80% angry  
  corp_ang_80 = cor(ERT_cor_80_ang)
  corrplot(corp_ang_80, method = "circle", type = "lower", tl.col = "black")
  
# Plot correlations - 100% angry  
  corp_ang_100 = cor(ERT_cor_100_ang)
  corrplot(corp_ang_100, method = "circle", type = "lower", tl.col = "black")   

```

